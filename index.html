<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toscanini CRM Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#3AAFA9;--primary-dark:#2B7A78;--primary-light:#DEF2F1;--text-dark:#17252A;--text-gray:#5C6B6B;--text-light:#8A9A9A;--white:#FFFFFF;--bg-light:#FAFAFA;--border:#E8E8E8;--success:#4CAF50;--warning:#FF9800;--danger:#E57373;--shadow:0 2px 10px rgba(0,0,0,0.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Open Sans',sans-serif;background:var(--bg-light);color:var(--text-dark);line-height:1.6;font-size:16px}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:var(--white);border-bottom:1px solid var(--border);padding:15px 0;position:sticky;top:0;z-index:100}
        .header-content{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
        .logo img{height:28px;width:auto}
        .user-info{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
        .user-name{font-size:1rem;color:var(--text-gray)}
        .user-name strong{color:var(--primary-dark);font-weight:600}
        .btn-logout{padding:10px 24px;background:transparent;border:1px solid var(--border);color:var(--text-gray);font-size:1rem;cursor:pointer;transition:all 0.3s;border-radius:6px}
        .btn-logout:hover{border-color:var(--primary);color:var(--primary)}
        
        /* Test Mode Toggle */
        .test-mode-toggle{display:flex;align-items:center;gap:10px;padding:8px 16px;background:#FFEBEE;border:2px solid var(--danger);border-radius:8px;font-size:0.9rem;color:var(--danger)}
        .test-mode-toggle.active{background:#FFCDD2}
        .test-mode-toggle input{width:18px;height:18px;accent-color:var(--danger)}
        
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary-light),var(--white));animation:fadeIn 0.5s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .login-box{background:var(--white);border-radius:12px;padding:50px;max-width:450px;width:100%;text-align:center;box-shadow:var(--shadow)}
        .login-logo{margin-bottom:20px;text-align:center}
        .login-logo img{height:32px;width:auto;display:inline-block}
        .login-box .subtitle{color:var(--text-light);margin-bottom:40px;font-size:1.1rem}
        .select-wrapper{position:relative;margin-bottom:24px}
        .select-wrapper select{width:100%;padding:16px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:1.1rem;cursor:pointer;appearance:none;transition:all 0.3s}
        .select-wrapper select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .select-wrapper::after{content:'‚ñæ';position:absolute;right:18px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none;font-size:1.2rem}
        .btn-primary{width:100%;padding:16px 28px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .dashboard{display:none;animation:fadeIn 0.5s}
        .dashboard.active{display:block}
        .tabs{display:flex;background:var(--white);border-radius:8px;padding:6px;margin:24px 0;box-shadow:var(--shadow)}
        .tab{flex:1;padding:16px 24px;background:transparent;border:none;border-radius:6px;color:var(--text-gray);font-family:inherit;font-size:1rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .tab:hover{color:var(--text-dark)}
        .tab.active{background:var(--primary);color:var(--white)}
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn 0.3s}
        .card{background:var(--white);border-radius:12px;padding:28px;margin-bottom:20px;box-shadow:var(--shadow)}
        .card-title{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:500;color:var(--text-dark);margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .card-title .icon{color:var(--primary);font-size:1.3rem}
        .acquisition-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
        @media(max-width:600px){.acquisition-buttons{grid-template-columns:1fr}}
        .btn-acquisition{padding:18px;background:var(--bg-light);border:2px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:1rem;cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:8px}
        .btn-acquisition:hover{border-color:var(--primary);background:var(--primary-light)}
        .btn-acquisition.active{border-color:var(--primary);background:var(--primary-light)}
        .btn-acquisition .icon{font-size:1.8rem}
        .camera-section{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media(max-width:900px){.camera-section{grid-template-columns:1fr}}
        .camera-container{width:100%;aspect-ratio:4/3;background:var(--bg-light);border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:16px}
        .camera-container video,.camera-container img{width:100%;height:100%;object-fit:cover;border-radius:6px}
        .camera-placeholder{text-align:center;color:var(--text-light)}
        .camera-placeholder .icon{font-size:3.5rem;margin-bottom:10px;color:var(--primary);opacity:0.5}
        .camera-placeholder p{font-size:1.1rem}
        .camera-buttons{display:flex;gap:12px}
        .btn-secondary{flex:1;padding:14px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:1rem;cursor:pointer;transition:all 0.3s}
        .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
        .btn-capture{flex:1;padding:14px 20px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .btn-capture:hover{background:var(--primary-dark)}
        .btn-capture:disabled{opacity:0.5;cursor:not-allowed}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-size:0.95rem;color:var(--text-gray);font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:1.1rem;transition:all 0.3s}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .form-group input:read-only{background:var(--bg-light);color:var(--text-gray)}
        .form-group textarea{min-height:120px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .location-info{background:var(--primary-light);border-radius:8px;padding:14px 18px;margin-bottom:20px;font-size:1rem;color:var(--primary-dark);display:flex;align-items:center;gap:10px}
        .location-info .icon{font-size:1.4rem}
        .category-label{font-size:0.9rem;color:var(--primary-dark);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-top:24px;margin-bottom:14px;display:block}
        .allegati-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
        .allegato-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s}
        .allegato-item:hover,.allegato-item.selected{border-color:var(--primary);background:var(--primary-light)}
        .allegato-item input[type="checkbox"]{accent-color:var(--primary);width:20px;height:20px}
        .allegato-item span{font-size:1rem;color:var(--text-dark)}
        .email-preview{background:var(--white);border:1px solid var(--border);border-radius:8px;padding:24px;font-family:Arial,sans-serif;font-size:15px;line-height:1.6;max-height:400px;overflow-y:auto;color:#333}
        .action-buttons{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
        .btn-approve{flex:1;min-width:150px;padding:16px 24px;background:var(--success);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-approve:hover{background:#43A047;transform:translateY(-1px)}
        .btn-save{flex:1;min-width:150px;padding:16px 24px;background:var(--warning);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-save:hover{background:#F57C00;transform:translateY(-1px)}
        .btn-reject{flex:1;min-width:150px;padding:16px 24px;background:var(--white);border:2px solid var(--danger);border-radius:8px;color:var(--danger);font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-reject:hover{background:var(--danger);color:var(--white)}
        .btn-continue{flex:1;min-width:150px;padding:16px 24px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-continue:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .btn-edit-toggle{padding:12px 24px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-gray);font-family:inherit;font-size:1rem;cursor:pointer;transition:all 0.3s;margin-top:16px}
        .btn-edit-toggle:hover{border-color:var(--primary);color:var(--primary)}
        .edit-section{display:none;margin-top:20px}
        .edit-section.visible{display:block}
        .generate-section{text-align:center;margin-top:28px}
        .btn-generate{padding:18px 40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(58,175,169,0.3)}
        .btn-generate:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(58,175,169,0.4)}
        .leads-table{width:100%;border-collapse:collapse}
        .leads-table th,.leads-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border);font-size:1rem}
        .leads-table th{background:var(--bg-light);font-weight:600;color:var(--text-gray);text-transform:uppercase;font-size:0.9rem}
        .leads-table tr:hover{background:var(--primary-light)}
        .lead-name{font-weight:500;color:var(--text-dark)}
        .lead-company{color:var(--text-gray)}
        .lead-status{padding:6px 14px;border-radius:20px;font-size:0.9rem;font-weight:500}
        .lead-status.pending{background:#FFF3E0;color:#E65100}
        .lead-status.approved{background:#E8F5E9;color:#2E7D32}
        .lead-status.rejected{background:#FFEBEE;color:#C62828}
        .lead-actions{display:flex;gap:8px}
        .btn-icon{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;transition:all 0.3s;font-size:1.1rem}
        .btn-icon.approve{background:#E8F5E9;color:#43A047}
        .btn-icon.approve:hover{background:#43A047;color:white}
        .btn-icon.reject{background:#FFEBEE;color:#E57373}
        .btn-icon.reject:hover{background:#E57373;color:white}
        .btn-icon.edit{background:#E3F2FD;color:#1976D2}
        .btn-icon.edit:hover{background:#1976D2;color:white}
        .loading{text-align:center;padding:40px}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--white);padding:16px 28px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:1000;opacity:0;transition:all 0.3s;font-size:1rem}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--primary)}
        @media(max-width:768px){.header-content{flex-direction:column;gap:12px}.leads-table th:nth-child(3),.leads-table td:nth-child(3){display:none}.login-box{margin:20px;padding:30px}.tabs{flex-direction:column}.action-buttons{flex-direction:column}}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
        .empty-state .icon{font-size:4rem;margin-bottom:16px;opacity:0.5}
        .empty-state p{font-size:1.1rem}
        .recording-section{margin-bottom:20px;padding:24px;background:linear-gradient(135deg, #FFF8E1, #FFECB3);border-radius:8px;border:2px solid #FFD54F}
        .recording-toggle{display:flex;align-items:center;justify-content:space-between;gap:16px}
        .recording-label{display:flex;align-items:center;gap:12px;font-size:1.1rem;color:var(--text-dark);font-weight:500}
        .recording-label .mic-icon{font-size:1.6rem}
        .toggle-switch{position:relative;width:64px;height:34px;background:var(--border);border-radius:17px;cursor:pointer;transition:all 0.3s}
        .toggle-switch.active{background:var(--danger)}
        .toggle-switch::after{content:'';position:absolute;width:28px;height:28px;background:var(--white);border-radius:50%;top:3px;left:3px;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .toggle-switch.active::after{left:33px}
        .recording-status{font-size:1rem;color:var(--text-light);margin-top:14px;display:flex;align-items:center;gap:10px}
        .recording-status.active{color:var(--danger);font-weight:500}
        .recording-dot{width:12px;height:12px;background:var(--danger);border-radius:50%;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .transcription-loading{display:flex;align-items:center;gap:12px;padding:16px;background:#FFF8E1;border-radius:8px;margin-top:14px;font-size:1rem;color:#F9A825}
        .quick-actions{margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
        .checkbox-option{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s;margin-top:14px}
        .checkbox-option:hover,.checkbox-option.selected{border-color:var(--primary);background:var(--primary-light)}
        .checkbox-option input[type="checkbox"]{accent-color:var(--primary);width:20px;height:20px}
        .checkbox-option label{font-size:1rem;color:var(--text-dark);cursor:pointer}
        .section-divider{border-top:1px solid var(--border);margin:24px 0;padding-top:24px}
        
        /* Phase sections */
        .phase-section{display:none}
        .phase-section.active{display:block}
        .phase-indicator{display:flex;justify-content:center;gap:8px;margin-bottom:24px}
        .phase-dot{width:12px;height:12px;border-radius:50%;background:var(--border)}
        .phase-dot.active{background:var(--primary)}
        .phase-dot.completed{background:var(--success)}
        
        /* Loading allegati */
        .allegati-loading{text-align:center;padding:30px;color:var(--text-light)}
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <p class="subtitle">CRM Portal - Gestione Contatti Fiera</p>
            <div class="select-wrapper">
                <select id="commercialeSelect">
                    <option value="">Seleziona il tuo profilo...</option>
                    <option value="federica@toscanini.it">Federica Toscanini</option>
                    <option value="marina.agliaudi@toscanini.it">Marina Agliaudi</option>
                    <option value="benedetta.giardino@toscanini.it">Benedetta Giardino</option>
                    <option value="alessandra.spruzzola@toscanini.it">Alessandra Spruzzola</option>
                    <option value="marina.raimondi@toscanini.it">Marina Raimondi</option>
                    <option value="simona.giuppone@toscanini.it">Simona Giuppone (Backoffice)</option>
                </select>
            </div>
            <button class="btn-primary" id="btnLogin" disabled>Accedi</button>
        </div>
    </div>
    
    <header class="header" id="mainHeader" style="display:none;">
        <div class="header-content">
            <div class="logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <div class="user-info">
                <label class="test-mode-toggle" id="testModeToggle">
                    <input type="checkbox" id="testModeCheckbox">
                    <span>üß™ Modalit√† Test</span>
                </label>
                <span class="user-name">Ciao, <strong id="userName"></strong></span>
                <button class="btn-logout" id="btnLogout">Esci</button>
            </div>
        </div>
    </header>
    
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="tabs">
                <button class="tab active" data-tab="newLead">‚ûï Nuovo Contatto</button>
                <button class="tab" data-tab="leadList">üìã Da Approvare</button>
            </div>
            
            <div id="tabNewLead" class="tab-content active">
                <!-- FASE 1: Acquisizione -->
                <div id="phase1" class="phase-section active">
                    <!-- REGISTRAZIONE AUDIO -->
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üé§</span> Registrazione Conversazione</h2>
                        <p style="font-size:1rem;color:var(--text-gray);margin-bottom:16px;">Attiva la registrazione <strong>prima</strong> di iniziare a parlare con il cliente</p>
                        <div class="recording-section" style="margin:0;">
                            <div class="recording-toggle">
                                <div class="recording-label"><span class="mic-icon">üé§</span><span>Registra conversazione</span></div>
                                <div class="toggle-switch" id="recordingToggle"></div>
                            </div>
                            <div class="recording-status" id="recordingStatus"><span>Tocca per registrare</span></div>
                            <div class="transcription-loading" id="transcriptionLoading" style="display:none;">
                                <div class="spinner" style="width:24px;height:24px;margin:0;border-width:2px;"></div>
                                <span>Trascrizione in corso...</span>
                            </div>
                        </div>
                    </div>

                    <!-- METODO ACQUISIZIONE -->
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üì•</span> Metodo Acquisizione</h2>
                        <div class="acquisition-buttons">
                            <button class="btn-acquisition active" data-method="biglietto">
                                <span class="icon">üì∑</span>
                                <span>Biglietto da Visita</span>
                            </button>
                            <button class="btn-acquisition" data-method="nfc">
                                <span class="icon">üì±</span>
                                <span>vCard</span>
                            </button>
                            <button class="btn-acquisition" data-method="manuale">
                                <span class="icon">‚úçÔ∏è</span>
                                <span>Manuale</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- CAMERA E DATI -->
                    <div class="camera-section">
                        <div class="card" id="cameraCard">
                            <h2 class="card-title"><span class="icon">üì∑</span> Scansiona Biglietto</h2>
                            <div class="camera-container" id="cameraContainer">
                                <div class="camera-placeholder" id="cameraPlaceholder">
                                    <div class="icon">üì∏</div>
                                    <p>Clicca per scattare foto</p>
                                </div>
                                <video id="videoElement" autoplay playsinline style="display:none;"></video>
                                <img id="capturedImage" style="display:none;">
                            </div>
                            <div class="camera-buttons">
                                <button class="btn-secondary" id="btnStartCamera">üì∑ Avvia Camera</button>
                                <button class="btn-capture" id="btnCapture" disabled>Scatta Foto</button>
                            </div>
                            <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
                        </div>
                        
                        <div class="card">
                            <h2 class="card-title"><span class="icon">üìã</span> Dati Contatto</h2>
                            <div class="location-info" id="locationInfo">
                                <span class="icon">üìç</span>
                                <span id="locationText">Rilevamento posizione...</span>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Data/Ora</label><input type="text" id="fieldDataOra" readonly></div>
                                <div class="form-group"><label>Fonte</label><input type="text" id="fieldFonte" value="Biglietto" readonly></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Nome</label><input type="text" id="fieldNome" placeholder="Nome"></div>
                                <div class="form-group"><label>Cognome</label><input type="text" id="fieldCognome" placeholder="Cognome"></div>
                            </div>
                            <div class="form-group"><label>Email</label><input type="email" id="fieldEmail" placeholder="email@esempio.com"></div>
                            <div class="form-group"><label>Telefono</label><input type="tel" id="fieldTelefono" placeholder="+39..."></div>
                            <div class="form-row">
                                <div class="form-group"><label>Azienda</label><input type="text" id="fieldAzienda" placeholder="Azienda"></div>
                                <div class="form-group"><label>Ruolo</label><input type="text" id="fieldRuolo" placeholder="Ruolo"></div>
                            </div>
                            <div class="form-group"><label>Indirizzo</label><input type="text" id="fieldIndirizzo" placeholder="Indirizzo"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Nazione</label><input type="text" id="fieldNazione" placeholder="Nazione"></div>
                                <div class="form-group">
                                    <label>Lingua Email</label>
                                    <select id="fieldLingua">
                                        <option value="italiano">Italiano</option>
                                        <option value="english">English</option>
                                        <option value="fran√ßais">Fran√ßais</option>
                                        <option value="espa√±ol">Espa√±ol</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="section-divider"></div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo Cliente</label>
                                        <select id="fieldTipoCliente">
                                            <option value="">Seleziona...</option>
                                            <optgroup label="‚îÄ‚îÄ MODA ‚îÄ‚îÄ">
                                                <option value="moda_azienda_uomo_donna">Azienda Moda Uomo Donna</option>
                                                <option value="moda_azienda_bimbo">Azienda Moda Bimbo</option>
                                                <option value="moda_azienda_intimo">Azienda Moda Intimo</option>
                                                <option value="moda_negozio_uomo_donna">Negozio Moda Uomo Donna</option>
                                                <option value="moda_negozio_bimbo">Negozio Moda Bimbo</option>
                                                <option value="moda_negozio_intimo">Negozio Moda Intimo</option>
                                                <option value="moda_vetrinisti">Vetrinisti / Allestitori</option>
                                                <option value="moda_sartorie">Sartorie</option>
                                                <option value="moda_dept_store">Dept. Store / Portale Moda</option>
                                            </optgroup>
                                            <optgroup label="‚îÄ‚îÄ INTERIOR ‚îÄ‚îÄ">
                                                <option value="interior_architetto_hotel">Architetto/Interior - Hotel</option>
                                                <option value="interior_architetto_residenziale">Architetto/Interior - Residenziale</option>
                                                <option value="interior_architetto_nautica">Architetto/Interior - Nautica</option>
                                                <option value="interior_architetto_retail">Architetto/Interior - Retail</option>
                                                <option value="interior_cantiere_navale">Cantiere Navale</option>
                                                <option value="interior_hotel">Hotel</option>
                                                <option value="interior_mobilifici_produttori">Mobilifici (Produttori)</option>
                                                <option value="interior_mobilifici_rivenditori">Mobilifici (Rivenditori)</option>
                                                <option value="interior_privati_web">Privati / Web</option>
                                                <option value="interior_yacht">Yacht</option>
                                                <option value="interior_dept_store">Dept. Store / Negozio / Portale</option>
                                            </optgroup>
                                            <optgroup label="‚îÄ‚îÄ VARIE ‚îÄ‚îÄ">
                                                <option value="varie_stockisti">Varie (stockisti)</option>
                                                <option value="varie_agenzie_pubblicita">Agenzie Pubblicit√† / Promozionale</option>
                                                <option value="varie_fornitori">Altro Fornitori</option>
                                            </optgroup>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <label>Commerciale di Riferimento</label>
                                    <select id="fieldCommercialeRif">
                                        <option value="">Seleziona...</option>
                                        <option value="federica@toscanini.it">Federica Toscanini</option>
                                        <option value="marina.agliaudi@toscanini.it">Marina Agliaudi</option>
                                        <option value="benedetta.giardino@toscanini.it">Benedetta Giardino</option>
                                        <option value="alessandra.spruzzola@toscanini.it">Alessandra Spruzzola</option>
                                        <option value="marina.raimondi@toscanini.it">Marina Raimondi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group"><label>Note Commerciale</label><textarea id="fieldNote" placeholder="Riassunto conversazione (generato automaticamente dalla registrazione)..."></textarea></div>
                            
                            <!-- AZIONI FASE 1 -->
                            <div class="quick-actions">
                                <div class="action-buttons">
                                    <button class="btn-continue" id="btnContinue">‚û°Ô∏è Continua</button>
                                    <button class="btn-save" id="btnQuickSave">üìÅ Salva per dopo</button>
                                    <button class="btn-reject" id="btnQuickReject">üóëÔ∏è Scarta</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- FASE 2: Email -->
                <div id="phase2" class="phase-section">
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üìé</span> Seleziona Allegati</h2>
                        <div id="allegatiContainer">
                            <div class="allegati-loading">
                                <div class="spinner"></div>
                                <p>Caricamento allegati...</p>
                            </div>
                        </div>
                        
                        <div class="section-divider"></div>
                        <div class="checkbox-option" id="ccBackofficeOption">
                            <input type="checkbox" id="ccBackoffice" name="ccBackoffice">
                            <label for="ccBackoffice">üìß Metti in copia Backoffice (per offerte)</label>
                        </div>
                    </div>
                    
                    <div class="generate-section">
                        <button class="btn-generate" id="btnGenerateEmail">‚úâÔ∏è Genera Anteprima Email</button>
                    </div>
                    
                    <div class="card" id="emailPreviewBox" style="display:none;">
                        <h2 class="card-title"><span class="icon">‚úâÔ∏è</span> Anteprima Email</h2>
                        <div class="email-preview" id="emailPreview"></div>
                        <button class="btn-edit-toggle" id="btnEditToggle">‚úèÔ∏è Modifica email</button>
                        <div class="edit-section" id="editSection">
                            <div class="form-group"><label>Modifica testo</label><textarea id="emailEditText" style="min-height:200px;"></textarea></div>
                            <button class="btn-secondary" id="btnUpdatePreview" style="margin-top:12px;">Aggiorna anteprima</button>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-approve" id="btnApprove">‚úÖ Approva e Invia</button>
                            <button class="btn-save" id="btnSaveForLater">üìÅ Salva</button>
                            <button class="btn-reject" id="btnReject">üóëÔ∏è Scarta</button>
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-top:20px;">
                        <button class="btn-secondary" id="btnBackToPhase1">‚¨ÖÔ∏è Torna indietro</button>
                    </div>
                </div>
            </div>
            
            <div id="tabLeadList" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><span class="icon">üìã</span> Contatti da Approvare</h2>
                    <div id="leadsContainer"><div class="loading"><div class="spinner"></div>Caricamento...</div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    <canvas id="canvas" style="display:none;"></canvas>

<script>
const API_BASE='https://giotosca.app.n8n.cloud/webhook';
const TEST_EMAIL='giovanni@toscanini.it';

let currentUser=null,currentUserEmail=null,currentLeadData=null,currentRowNumber=null,videoStream=null,currentEmailHtml='';
let mediaRecorder=null,audioChunks=[],isRecording=false,recordingStartTime=null,recordingTimer=null;
let currentPosition={lat:null,lng:null,location:''};
let acquisitionMethod='biglietto';
let testMode=false;
let allegatiList=[];

const commercialiData={
    'federica@toscanini.it':{name:'Federica Toscanini',email:'federica@toscanini.it'},
    'marina.agliaudi@toscanini.it':{name:'Marina Agliaudi',email:'marina.agliaudi@toscanini.it'},
    'benedetta.giardino@toscanini.it':{name:'Benedetta Giardino',email:'benedetta.giardino@toscanini.it'},
    'alessandra.spruzzola@toscanini.it':{name:'Alessandra Spruzzola',email:'alessandra.spruzzola@toscanini.it'},
    'marina.raimondi@toscanini.it':{name:'Marina Raimondi',email:'marina.raimondi@toscanini.it'},
    'simona.giuppone@toscanini.it':{name:'Simona Giuppone',email:'simona.giuppone@toscanini.it'}
};

document.addEventListener('DOMContentLoaded',()=>{
    const saved=localStorage.getItem('toscanini_user');
    if(saved){currentUserEmail=saved;currentUser=commercialiData[saved]?.name||saved;showDashboard()}
    
    // Test mode
    document.getElementById('testModeCheckbox').addEventListener('change',e=>{
        testMode=e.target.checked;
        document.getElementById('testModeToggle').classList.toggle('active',testMode);
        showToast(testMode?'Modalit√† Test ATTIVA - Email a '+TEST_EMAIL:'Modalit√† Test disattivata',testMode?'info':'success');
    });
    
    document.getElementById('commercialeSelect').addEventListener('change',e=>document.getElementById('btnLogin').disabled=!e.target.value);
    document.getElementById('btnLogin').addEventListener('click',login);
    document.getElementById('btnLogout').addEventListener('click',logout);
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
    document.getElementById('btnStartCamera').addEventListener('click',startCamera);
    document.getElementById('btnCapture').addEventListener('click',capturePhoto);
    document.getElementById('fileInput').addEventListener('change',handleFileSelect);
    document.getElementById('btnGenerateEmail').addEventListener('click',generateEmail);
    document.getElementById('btnApprove').addEventListener('click',approveLead);
    document.getElementById('btnSaveForLater').addEventListener('click',saveForLater);
    document.getElementById('btnQuickSave').addEventListener('click',saveForLater);
    document.getElementById('btnReject').addEventListener('click',rejectLead);
    document.getElementById('btnQuickReject').addEventListener('click',rejectLead);
    document.getElementById('btnContinue').addEventListener('click',goToPhase2);
    document.getElementById('btnBackToPhase1').addEventListener('click',goToPhase1);
    document.getElementById('btnEditToggle').addEventListener('click',()=>{
        const section=document.getElementById('editSection');
        section.classList.toggle('visible');
        document.getElementById('btnEditToggle').textContent=section.classList.contains('visible')?'‚úï Chiudi':'‚úèÔ∏è Modifica email';
    });
    document.getElementById('btnUpdatePreview').addEventListener('click',updatePreviewFromText);
    document.getElementById('recordingToggle').addEventListener('click',toggleRecording);
    document.querySelectorAll('.btn-acquisition').forEach(btn=>btn.addEventListener('click',()=>setAcquisitionMethod(btn.dataset.method)));
    
    // CC Backoffice toggle
    document.getElementById('ccBackofficeOption').addEventListener('click',e=>{
        if(e.target.type!=='checkbox'){document.getElementById('ccBackoffice').checked=!document.getElementById('ccBackoffice').checked}
        document.getElementById('ccBackofficeOption').classList.toggle('selected',document.getElementById('ccBackoffice').checked);
    });
    
    initDateTime();
    initGeolocation();
});

function goToPhase1(){
    document.getElementById('phase1').classList.add('active');
    document.getElementById('phase2').classList.remove('active');
}

function goToPhase2(){
    const d=getFormData();
    if(!d.nome&&!d.email&&!d.azienda){showToast('Inserisci almeno un dato','error');return}
    if(!d.commercialeRiferimento){showToast('Seleziona il commerciale di riferimento','error');return}
    
    document.getElementById('phase1').classList.remove('active');
    document.getElementById('phase2').classList.add('active');
    loadAllegati();
    window.scrollTo({top:0,behavior:'smooth'});
}

async function loadAllegati(){
    const container=document.getElementById('allegatiContainer');
    container.innerHTML='<div class="allegati-loading"><div class="spinner"></div><p>Caricamento allegati...</p></div>';
    
    try{
        const r=await fetch(API_BASE+'/lista-allegati');
        const files=await r.json();
        allegatiList=files;
        
        if(!files.length){
            container.innerHTML='<p style="color:var(--text-light);text-align:center;">Nessun allegato disponibile</p>';
            return;
        }
        
        let html='<div class="allegati-grid">';
        files.forEach(f=>{
            html+=`<label class="allegato-item" data-url="${f.url||f.webViewLink||''}">
                <input type="checkbox" name="allegati" value="${f.id}" data-name="${f.name}" data-url="${f.url||f.webViewLink||''}">
                <span>${f.name.replace(/\.[^/.]+$/,'')}</span>
            </label>`;
        });
        html+='</div>';
        container.innerHTML=html;
        
        // Add click handlers
        document.querySelectorAll('#allegatiContainer .allegato-item').forEach(item=>{
            item.addEventListener('click',e=>{
                if(e.target.type!=='checkbox'){item.querySelector('input').checked=!item.querySelector('input').checked}
                item.classList.toggle('selected',item.querySelector('input').checked);
            });
        });
    }catch(e){
        console.error('Errore caricamento allegati:',e);
        container.innerHTML='<p style="color:var(--danger);text-align:center;">Errore caricamento allegati</p>';
    }
}

function initDateTime(){
    const now=new Date();
    document.getElementById('fieldDataOra').value=now.toLocaleString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function initGeolocation(){
    if(!navigator.geolocation){document.getElementById('locationText').textContent='GPS non supportato';return}
    navigator.geolocation.getCurrentPosition(async pos=>{
        currentPosition.lat=pos.coords.latitude;
        currentPosition.lng=pos.coords.longitude;
        try{
            const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
            const d=await r.json();
            currentPosition.location=[d.address.city||d.address.town||d.address.village||'',d.address.country||''].filter(Boolean).join(', ');
            document.getElementById('locationText').textContent='üìç '+currentPosition.location;
            document.getElementById('locationInfo').style.cssText='background:#E8F5E9;color:#43A047';
        }catch(e){
            currentPosition.location=`${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
            document.getElementById('locationText').textContent='üìç '+currentPosition.location;
        }
    },()=>{
        document.getElementById('locationText').textContent='Posizione non disponibile';
        document.getElementById('locationInfo').style.cssText='background:#FFEBEE;color:#E57373';
    },{enableHighAccuracy:true,timeout:10000});
}

function setAcquisitionMethod(method){
    acquisitionMethod=method;
    document.querySelectorAll('.btn-acquisition').forEach(b=>b.classList.remove('active'));
    document.querySelector(`[data-method="${method}"]`).classList.add('active');
    document.getElementById('cameraCard').style.display=method==='biglietto'?'block':'none';
    document.getElementById('fieldFonte').value=method==='biglietto'?'Biglietto':method==='nfc'?'NFC':'Manuale';
    if(method==='nfc')initNFC();
}

function initNFC(){
    if(!('NDEFReader'in window)){showToast('NFC non supportato','error');return}
    showToast('Avvicina al tag NFC...','info');
    const ndef=new NDEFReader();
    ndef.scan().then(()=>{
        ndef.onreading=e=>{
            for(const rec of e.message.records){
                if(rec.recordType==='text')parseVCard(new TextDecoder().decode(rec.data));
            }
        };
    }).catch(err=>showToast('NFC: '+err.message,'error'));
}

function parseVCard(text){
    text.split(/\r?\n/).forEach(line=>{
        if(line.startsWith('FN:')){const n=line.substring(3).split(' ');document.getElementById('fieldNome').value=n[0]||'';document.getElementById('fieldCognome').value=n.slice(1).join(' ')||''}
        if(line.startsWith('EMAIL:'))document.getElementById('fieldEmail').value=line.substring(6);
        if(line.startsWith('TEL:'))document.getElementById('fieldTelefono').value=line.substring(4);
        if(line.startsWith('ORG:'))document.getElementById('fieldAzienda').value=line.substring(4);
        if(line.startsWith('TITLE:'))document.getElementById('fieldRuolo').value=line.substring(6);
    });
    showToast('Contatto NFC importato!','success');
}

function login(){
    currentUserEmail=document.getElementById('commercialeSelect').value;
    currentUser=commercialiData[currentUserEmail]?.name||currentUserEmail;
    localStorage.setItem('toscanini_user',currentUserEmail);
    showDashboard();
}

function logout(){
    currentUserEmail=null;currentUser=null;
    localStorage.removeItem('toscanini_user');
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('mainHeader').style.display='none';
    document.getElementById('dashboard').classList.remove('active');
    stopCamera();stopRecording();
}

function showDashboard(){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainHeader').style.display='block';
    document.getElementById('dashboard').classList.add('active');
    document.getElementById('userName').textContent=currentUser;
    loadLeads();
}

function switchTab(tabId){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tabId));
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.toggle('active',tc.id==='tab'+tabId.charAt(0).toUpperCase()+tabId.slice(1)));
    if(tabId==='leadList')loadLeads();
    if(tabId==='newLead')goToPhase1();
}

async function startCamera(){
    await stopCamera();
    try{
        videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}});
        const video=document.getElementById('videoElement');
        video.srcObject=videoStream;
        video.style.display='block';
        await video.play();
        document.getElementById('cameraPlaceholder').style.display='none';
        document.getElementById('capturedImage').style.display='none';
        document.getElementById('btnCapture').disabled=false;
        document.getElementById('btnStartCamera').textContent='üîÑ Reset';
    }catch(e){
        console.error('Camera error:',e);
        document.getElementById('fileInput').click();
    }
}

async function stopCamera(){
    if(videoStream){
        videoStream.getTracks().forEach(t=>{t.stop();t.enabled=false});
        videoStream=null;
    }
    const video=document.getElementById('videoElement');
    if(video.srcObject){video.srcObject=null}
    video.style.display='none';
    document.getElementById('btnCapture').disabled=true;
}

function capturePhoto(){
    const canvas=document.getElementById('canvas'),video=document.getElementById('videoElement');
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const img=canvas.toDataURL('image/jpeg',0.8);
    showCapturedImage(img);
    processImage(img.split(',')[1]);
}

function handleFileSelect(e){
    const file=e.target.files[0];
    if(file){
        const reader=new FileReader();
        reader.onload=ev=>{showCapturedImage(ev.target.result);processImage(ev.target.result.split(',')[1])};
        reader.readAsDataURL(file);
    }
    e.target.value='';
}

async function showCapturedImage(src){
    await stopCamera();
    document.getElementById('capturedImage').src=src;
    document.getElementById('capturedImage').style.display='block';
    document.getElementById('cameraPlaceholder').style.display='none';
    document.getElementById('btnStartCamera').textContent='üì∑ Nuova Foto';
}

async function toggleRecording(){
    if(!isRecording){
        try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder=new MediaRecorder(stream);
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
            mediaRecorder.onstop=processAudio;
            mediaRecorder.start();
            isRecording=true;
            recordingStartTime=Date.now();
            document.getElementById('recordingToggle').classList.add('active');
            document.getElementById('recordingStatus').classList.add('active');
            recordingTimer=setInterval(updateRecordingTime,1000);
            updateRecordingTime();
            if(navigator.vibrate)navigator.vibrate(200);
        }catch(e){showToast('Errore microfono: '+e.message,'error')}
    }else{
        stopRecording();
    }
}

function stopRecording(){
    if(mediaRecorder&&mediaRecorder.state!=='inactive'){
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
    isRecording=false;
    clearInterval(recordingTimer);
    document.getElementById('recordingToggle').classList.remove('active');
    document.getElementById('recordingStatus').classList.remove('active');
    document.getElementById('recordingStatus').innerHTML='<span>Tocca per registrare</span>';
    if(navigator.vibrate)navigator.vibrate(100);
}

function updateRecordingTime(){
    const s=Math.floor((Date.now()-recordingStartTime)/1000);
    document.getElementById('recordingStatus').innerHTML=`<span class="recording-dot"></span><span class="recording-time">${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}</span><span>Registrazione...</span>`;
}

async function processAudio(){
    document.getElementById('transcriptionLoading').style.display='flex';
    showToast('Elaborazione audio...','info');
    try{
        const base64=await new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(new Blob(audioChunks,{type:'audio/webm'}))});
        const resp=await fetch(API_BASE+'/trascrivi-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audio:base64,commerciale:currentUser})});
        if(!resp.ok)throw new Error();
        const data=await resp.json();
        document.getElementById('fieldNote').value+=(document.getElementById('fieldNote').value?'\n\n':'')+data.riassunto;
        showToast('Trascrizione completata!','success');
    }catch(e){showToast('Errore trascrizione','error')}
    finally{document.getElementById('transcriptionLoading').style.display='none'}
}

async function processImage(base64){
    showToast('Elaborazione biglietto...','info');
    try{
        const r=await fetch(API_BASE+'/upload-biglietto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
            image:base64,
            commerciale:currentUser,
            commercialeEmail:currentUserEmail,
            dataOra:document.getElementById('fieldDataOra').value,
            posizione:currentPosition.location,
            lat:currentPosition.lat,
            lng:currentPosition.lng,
            fonte:acquisitionMethod,
            azienda:document.getElementById('fieldAzienda').value,
            cognome:document.getElementById('fieldCognome').value
        })});
        if(!r.ok)throw new Error();
        const d=await r.json();
        currentLeadData=d;
        currentRowNumber=d.row_number;
        
        ['nome','cognome','email','telefono','azienda','ruolo','indirizzo','nazione'].forEach(f=>{
            if(d[f])document.getElementById('field'+f.charAt(0).toUpperCase()+f.slice(1)).value=d[f]
        });
        
        // Lingua automatica
        if(d.lingua){
            const supportedLangs=['italiano','english','fran√ßais','espa√±ol'];
            const langLower=d.lingua.toLowerCase();
            document.getElementById('fieldLingua').value=supportedLangs.includes(langLower)?langLower:'english';
        }
        showToast('Dati estratti!','success');
    }catch(e){showToast('Errore. Compila manualmente.','error')}
}

function getFormData(){
    const selectedAllegati=Array.from(document.querySelectorAll('#allegatiContainer input[name="allegati"]:checked')).map(c=>({
        id:c.value,
        name:c.dataset.name,
        url:c.dataset.url
    }));
    
    return{
        nome:document.getElementById('fieldNome').value,
        cognome:document.getElementById('fieldCognome').value,
        email:document.getElementById('fieldEmail').value,
        telefono:(document.getElementById('fieldTelefono').value.startsWith('+') ? "'" : "") + document.getElementById('fieldTelefono').value,
        azienda:document.getElementById('fieldAzienda').value,
        ruolo:document.getElementById('fieldRuolo').value,
        indirizzo:document.getElementById('fieldIndirizzo').value,
        nazione:document.getElementById('fieldNazione').value,
        lingua:document.getElementById('fieldLingua').value,
        tipoCliente:document.getElementById('fieldTipoCliente').value,
        commercialeRiferimento:document.getElementById('fieldCommercialeRif').value,
        noteCommerciale:document.getElementById('fieldNote').value,
        allegatiSelezionati:selectedAllegati.map(a=>a.name).join(', '),
        allegatiUrls:selectedAllegati,
        ccBackoffice:document.getElementById('ccBackoffice')?.checked||false,
        dataOra:document.getElementById('fieldDataOra').value,
        posizione:currentPosition.location,
        lat:currentPosition.lat,
        lng:currentPosition.lng,
        fonte:document.getElementById('fieldFonte').value
    };
}

function generateEmail(){
    const d=getFormData();
    const lang=d.lingua;
    const nome=d.nome;
    const cognome=d.cognome;
    const commercialeRif=d.commercialeRiferimento||currentUserEmail;
    const commercialeNome=commercialiData[commercialeRif]?.name||currentUser;
    
    // Build attachment links
    let allegatiHtml='';
    if(d.allegatiUrls&&d.allegatiUrls.length){
        const items=d.allegatiUrls.map(a=>`<li style="margin:8px 0;"><a href="${a.url}" style="color:#3AAFA9;text-decoration:none;">üìé ${a.name.replace(/\.[^/.]+$/,'')}</a></li>`).join('');
        allegatiHtml=`<ul style="margin:15px 0 20px 20px;padding:0;list-style:none;">${items}</ul>`;
    }
    
    // Footer elements
    const socialLinks='<p style="margin-top:15px;"><a href="https://www.instagram.com/toscanini_official/" style="margin-right:15px;"><img src="https://cdn-icons-png.flaticon.com/24/174/174855.png" alt="Instagram"></a><a href="https://www.facebook.com/ToscaniniOfficial/" style="margin-right:15px;"><img src="https://cdn-icons-png.flaticon.com/24/174/174848.png" alt="Facebook"></a><a href="https://www.linkedin.com/company/toscanini-srl/"><img src="https://cdn-icons-png.flaticon.com/24/174/174857.png" alt="LinkedIn"></a></p>';
    const bannerImg='<img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Banner%20M%26O.png" style="max-width:400px;margin-top:15px;display:block;">';
    
    if(lang==='italiano'){
        currentEmailHtml=`<div style="font-family:Arial,sans-serif;max-width:600px;color:#333;line-height:1.6;">
            <p>Gentile ${nome} ${cognome},</p>
            <p>La ringrazio per aver visitato il nostro stand a <strong>Maison & Objet ‚Äì Parigi</strong>. √à stato un piacere incontrarLa e presentarLe le nostre collezioni.</p>
            <p>Come da accordi, Le invio di seguito i link ai materiali di approfondimento:</p>
            ${allegatiHtml}
            <p>Rimaniamo a Sua completa disposizione per qualsiasi ulteriore informazione o necessit√† di supporto sui Suoi progetti.</p>
            <p>La invito inoltre a seguirci sui nostri canali social per restare aggiornato sulle novit√† e ispirazioni dal mondo Toscanini.</p>
            <p>La ringrazio ancora per il tempo dedicatoci e spero avremo presto occasione di collaborare.</p>
            <p style="margin-top:25px;">Cordiali saluti,<br><strong>${commercialeNome}</strong><br>Industrie Toscanini S.r.l.<br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p>
            ${socialLinks}
            ${bannerImg}
        </div>`;
    }else if(lang==='fran√ßais'){
        currentEmailHtml=`<div style="font-family:Arial,sans-serif;max-width:600px;color:#333;line-height:1.6;">
            <p>Cher/Ch√®re ${nome} ${cognome},</p>
            <p>Je vous remercie d'avoir visit√© notre stand √† <strong>Maison & Objet ‚Äì Paris</strong>. Ce fut un plaisir de vous rencontrer et de vous pr√©senter nos collections.</p>
            <p>Comme convenu, veuillez trouver ci-dessous les liens vers nos documents:</p>
            ${allegatiHtml}
            <p>Nous restons √† votre enti√®re disposition pour toute information compl√©mentaire ou besoin d'accompagnement sur vos projets.</p>
            <p>Je vous invite √©galement √† nous suivre sur nos r√©seaux sociaux pour rester inform√© des nouveaut√©s et inspirations du monde Toscanini.</p>
            <p>Je vous remercie encore pour le temps que vous nous avez accord√© et j'esp√®re que nous aurons bient√¥t l'occasion de collaborer.</p>
            <p style="margin-top:25px;">Cordialement,<br><strong>${commercialeNome}</strong><br>Industrie Toscanini S.r.l.<br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p>
            ${socialLinks}
            ${bannerImg}
        </div>`;
    }else if(lang==='espa√±ol'){
        currentEmailHtml=`<div style="font-family:Arial,sans-serif;max-width:600px;color:#333;line-height:1.6;">
            <p>Estimado/a ${nome} ${cognome},</p>
            <p>Le agradezco por haber visitado nuestro stand en <strong>Maison & Objet ‚Äì Par√≠s</strong>. Fue un placer conocerle y presentarle nuestras colecciones.</p>
            <p>Como acordamos, le env√≠o a continuaci√≥n los enlaces a los materiales:</p>
            ${allegatiHtml}
            <p>Quedamos a su entera disposici√≥n para cualquier informaci√≥n adicional o necesidad de apoyo en sus proyectos.</p>
            <p>Le invito tambi√©n a seguirnos en nuestras redes sociales para estar al d√≠a de las novedades e inspiraciones del mundo Toscanini.</p>
            <p>Le agradezco nuevamente por el tiempo dedicado y espero que pronto tengamos la oportunidad de colaborar.</p>
            <p style="margin-top:25px;">Saludos cordiales,<br><strong>${commercialeNome}</strong><br>Industrie Toscanini S.r.l.<br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p>
            ${socialLinks}
            ${bannerImg}
        </div>`;
    }else{
        currentEmailHtml=`<div style="font-family:Arial,sans-serif;max-width:600px;color:#333;line-height:1.6;">
            <p>Dear ${nome} ${cognome},</p>
            <p>Thank you for visiting our stand at <strong>Maison & Objet ‚Äì Paris</strong>. It was a pleasure meeting you and presenting our collections.</p>
            <p>As agreed, please find below the links to our materials:</p>
            ${allegatiHtml}
            <p>We remain at your complete disposal for any further information or support needed on your projects.</p>
            <p>I also invite you to follow us on our social media channels to stay updated on news and inspirations from the Toscanini world.</p>
            <p>Thank you again for your time and I hope we will have the opportunity to collaborate soon.</p>
            <p style="margin-top:25px;">Best regards,<br><strong>${commercialeNome}</strong><br>Industrie Toscanini S.r.l.<br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p>
            ${socialLinks}
            ${bannerImg}
        </div>`;
    }
    
    document.getElementById('emailPreview').innerHTML=currentEmailHtml;
    document.getElementById('emailEditText').value=htmlToPlainText(currentEmailHtml);
    document.getElementById('emailPreviewBox').style.display='block';
    document.getElementById('emailPreviewBox').scrollIntoView({behavior:'smooth'});
}

function htmlToPlainText(html){const t=document.createElement('div');t.innerHTML=html;t.querySelectorAll('a').forEach(a=>a.textContent+=` (${a.href})`);return t.textContent||''}

function plainTextToHtml(text){
    const commercialeRif=document.getElementById('fieldCommercialeRif').value;
    const commercialeNome=commercialiData[commercialeRif]?.name||currentUser;
    let h='<div style="font-family:Arial;max-width:600px;color:#333;">';
    text.split('\n').filter(l=>l.trim()).forEach(l=>h+='<p>'+l.replace(/\(https?:\/\/[^\)]+\)/g,m=>`<a href="${m.slice(1,-1)}" style="color:#3AAFA9;">${m.slice(1,-1)}</a>`)+'</p>');
    h+=`<p style="margin-top:20px;"><b>${commercialeNome}</b><br>Industrie Toscanini S.r.l.<br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p>`;
    h+='</div>';
    return h;
}

function updatePreviewFromText(){
    currentEmailHtml=plainTextToHtml(document.getElementById('emailEditText').value);
    document.getElementById('emailPreview').innerHTML=currentEmailHtml;
    showToast('Anteprima aggiornata','success');
}

async function saveForLater(){
    const d=getFormData();
    if(!d.nome&&!d.email&&!d.azienda){showToast('Inserisci almeno un dato','error');return}
    showToast('Salvataggio...','info');
    try{
        const r=await fetch(API_BASE+'/salva-contatto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
            ...d,
            commerciale:currentUser,
            commercialeEmail:currentUserEmail,
            status:'da_approvare'
        })});
        if(!r.ok)throw new Error();
        const data=await r.json();
        currentRowNumber=data.row_number;
        showToast('Salvato! Potrai riprenderlo dalla lista.','success');
        resetForm();
    }catch(e){showToast('Errore salvataggio','error')}
}

async function approveLead(){
    const d=getFormData();
    if(!d.nome&&!d.email){showToast('Inserisci nome o email','error');return}
    if(!d.commercialeRiferimento){showToast('Seleziona il commerciale di riferimento','error');return}
    
    showToast('Salvataggio e invio...','info');
    
    // Determina email destinatario
    const emailTo=testMode?TEST_EMAIL:d.email;
    
    // CC: commerciale mittente + backoffice se selezionato
    let ccList=[d.commercialeRiferimento]; // CC al commerciale che invia
    if(d.ccBackoffice)ccList.push('simona.giuppone@toscanini.it');
    
    try{
        // Prima salva se non esiste
        if(!currentRowNumber){
            const saveResp=await fetch(API_BASE+'/salva-contatto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
                ...d,
                commerciale:currentUser,
                commercialeEmail:currentUserEmail,
                status:'APPROVATO'
            })});
            if(saveResp.ok){
                const saveData=await saveResp.json();
                currentRowNumber=saveData.row_number;
            }
        }
        
        // Poi approva
        const r=await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
            ...d,
            row_number:currentRowNumber,
            commerciale:currentUser,
            commercialeEmail:currentUserEmail,
            emailGenerata:currentEmailHtml,
            emailTo:emailTo,
            emailCc:ccList.join(', '),
            emailFrom:d.commercialeRiferimento,
            status:'APPROVATO'
        })});
        
        if(!r.ok)throw new Error();
        showToast(testMode?'Email inviata a '+TEST_EMAIL+' (test)':'Approvato! Email inviata.','success');
        resetForm();
    }catch(e){
        console.error(e);
        showToast('Errore invio','error');
    }
}

async function rejectLead(){
    if(!confirm('Sei sicuro di voler scartare questo contatto?'))return;
    
    if(currentRowNumber){
        try{
            await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:currentRowNumber,motivoScarto:'Scartato manualmente'})});
        }catch(e){}
    }
    showToast('Contatto scartato','success');
    resetForm();
}

function resetForm(){
    ['fieldNome','fieldCognome','fieldEmail','fieldTelefono','fieldAzienda','fieldRuolo','fieldIndirizzo','fieldNazione','fieldNote'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('fieldLingua').value='italiano';
    document.getElementById('fieldTipoCliente').value='';
    document.getElementById('fieldCommercialeRif').value='';
    if(document.getElementById('ccBackoffice')){
        document.getElementById('ccBackoffice').checked=false;
        document.getElementById('ccBackofficeOption').classList.remove('selected');
    }
    document.querySelectorAll('#allegatiContainer input[name="allegati"]').forEach(c=>{c.checked=false;c.closest('.allegato-item')?.classList.remove('selected')});
    document.getElementById('emailPreviewBox').style.display='none';
    document.getElementById('capturedImage').style.display='none';
    document.getElementById('cameraPlaceholder').style.display='block';
    document.getElementById('btnStartCamera').textContent='üì∑ Avvia Camera';
    currentLeadData=null;currentRowNumber=null;currentEmailHtml='';
    goToPhase1();
    initDateTime();
    window.scrollTo({top:0,behavior:'smooth'});
}

async function loadLeads(){
    const container=document.getElementById('leadsContainer');
    container.innerHTML='<div class="loading"><div class="spinner"></div>Caricamento...</div>';
    try{
        const r=await fetch(API_BASE+'/leads');
        const leads=await r.json();
        if(!leads.length){container.innerHTML='<div class="empty-state"><div class="icon">üì≠</div><p>Nessun contatto da approvare</p></div>';return}
        container.innerHTML=`<table class="leads-table">
            <thead><tr><th>Nome</th><th>Azienda</th><th>Tipo</th><th>Stato</th><th>Azioni</th></tr></thead>
            <tbody>${leads.map(l=>`<tr>
                <td class="lead-name">${l.nome||''} ${l.cognome||''}</td>
                <td class="lead-company">${l.azienda||'-'}</td>
                <td>${l.tipoCliente||'-'}</td>
                <td><span class="lead-status ${l.status==='approvato'?'approved':l.status==='scartato'?'rejected':'pending'}">${l.status==='approvato'?'Approvato':l.status==='scartato'?'Scartato':'Da Approvare'}</span></td>
                <td class="lead-actions">
                    <button class="btn-icon edit" onclick="editLead(${JSON.stringify(l).replace(/"/g,'&quot;')})" title="Modifica">‚úèÔ∏è</button>
                    <button class="btn-icon approve" onclick="quickApprove('${l.email}')" title="Approva">‚úì</button>
                    <button class="btn-icon reject" onclick="quickReject('${l.email}')" title="Scarta">‚úï</button>
                </td>
            </tr>`).join('')}</tbody>
        </table>`;
    }catch(e){container.innerHTML='<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Errore caricamento</p></div>'}
}

function editLead(lead){
    // Popola il form con i dati del lead
    document.getElementById('fieldNome').value=lead.nome||'';
    document.getElementById('fieldCognome').value=lead.cognome||'';
    document.getElementById('fieldEmail').value=lead.email||'';
    document.getElementById('fieldTelefono').value=lead.telefono||'';
    document.getElementById('fieldAzienda').value=lead.azienda||'';
    document.getElementById('fieldRuolo').value=lead.ruolo||'';
    document.getElementById('fieldIndirizzo').value=lead.indirizzo||'';
    document.getElementById('fieldNazione').value=lead.nazione||'';
    document.getElementById('fieldLingua').value=lead.lingua||'italiano';
    document.getElementById('fieldTipoCliente').value=lead.tipoCliente||'';
    document.getElementById('fieldCommercialeRif').value=lead.commercialeRiferimento||lead.commercialeEmail||'';
    document.getElementById('fieldNote').value=lead.noteCommerciale||'';
    
    currentRowNumber=lead.row_number;
    currentLeadData=lead;
    
    // Passa al tab nuovo contatto
    switchTab('newLead');
    showToast('Contatto caricato per modifica','info');
}

async function quickApprove(email){
    if(!confirm('Approvare e inviare email?'))return;
    try{
        await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
            email:email,
            commerciale:currentUser,
            commercialeEmail:currentUserEmail,
            status:'APPROVATO'
        })});
        showToast('Approvato!','success');
        loadLeads();
    }catch(e){showToast('Errore','error')}
}

async function quickReject(email){
    if(!confirm('Sei sicuro di voler scartare questo contatto?'))return;
    try{
        await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:email,motivoScarto:'Scartato da lista'})});
        showToast('Scartato','success');
        loadLeads();
    }catch(e){showToast('Errore','error')}
}

function showToast(msg,type='info'){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.className='toast '+type+' show';
    setTimeout(()=>t.classList.remove('show'),3500);
}
</script>
</body>
</html>

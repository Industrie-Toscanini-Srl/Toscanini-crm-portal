<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toscanini CRM Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#3AAFA9;--primary-dark:#2B7A78;--primary-light:#DEF2F1;--text-dark:#17252A;--text-gray:#5C6B6B;--text-light:#8A9A9A;--white:#FFFFFF;--bg-light:#FAFAFA;--border:#E8E8E8;--success:#4CAF50;--warning:#FF9800;--danger:#E57373;--shadow:0 2px 10px rgba(0,0,0,0.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Open Sans',sans-serif;background:var(--bg-light);color:var(--text-dark);line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:var(--white);border-bottom:1px solid var(--border);padding:15px 0;position:sticky;top:0;z-index:100}
        .header-content{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
        .logo img{height:24px;width:auto}
        .user-info{display:flex;align-items:center;gap:20px}
        .user-name{font-size:0.9rem;color:var(--text-gray)}
        .user-name strong{color:var(--primary-dark);font-weight:600}
        .btn-logout{padding:8px 20px;background:transparent;border:1px solid var(--border);color:var(--text-gray);font-size:0.85rem;cursor:pointer;transition:all 0.3s;border-radius:4px}
        .btn-logout:hover{border-color:var(--primary);color:var(--primary)}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary-light),var(--white));animation:fadeIn 0.5s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .login-box{background:var(--white);border-radius:12px;padding:50px;max-width:420px;width:100%;text-align:center;box-shadow:var(--shadow)}
        .login-logo{margin-bottom:20px;text-align:center}
        .login-logo img{height:24px;width:auto;display:inline-block}
        .login-box .subtitle{color:var(--text-light);margin-bottom:40px;font-size:0.9rem}
        .select-wrapper{position:relative;margin-bottom:24px}
        .select-wrapper select{width:100%;padding:14px 18px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.95rem;cursor:pointer;appearance:none;transition:all 0.3s}
        .select-wrapper select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .select-wrapper::after{content:'‚ñæ';position:absolute;right:18px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none}
        .btn-primary{width:100%;padding:14px 28px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .dashboard{display:none;animation:fadeIn 0.5s}
        .dashboard.active{display:block}
        .tabs{display:flex;background:var(--white);border-radius:8px;padding:6px;margin:24px 0;box-shadow:var(--shadow)}
        .tab{flex:1;padding:14px 24px;background:transparent;border:none;border-radius:6px;color:var(--text-gray);font-family:inherit;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .tab:hover{color:var(--text-dark)}
        .tab.active{background:var(--primary);color:var(--white)}
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn 0.3s}
        .card{background:var(--white);border-radius:12px;padding:28px;margin-bottom:20px;box-shadow:var(--shadow)}
        .card-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:500;color:var(--text-dark);margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .card-title .icon{color:var(--primary)}
        .acquisition-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
        @media(max-width:600px){.acquisition-buttons{grid-template-columns:1fr}}
        .btn-acquisition{padding:16px;background:var(--bg-light);border:2px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.9rem;cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:8px}
        .btn-acquisition:hover{border-color:var(--primary);background:var(--primary-light)}
        .btn-acquisition.active{border-color:var(--primary);background:var(--primary-light)}
        .btn-acquisition .icon{font-size:1.5rem}
        .camera-section{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media(max-width:900px){.camera-section{grid-template-columns:1fr}}
        .camera-container{width:100%;aspect-ratio:4/3;background:var(--bg-light);border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:16px}
        .camera-container video,.camera-container img{width:100%;height:100%;object-fit:cover;border-radius:6px}
        .camera-placeholder{text-align:center;color:var(--text-light)}
        .camera-placeholder .icon{font-size:3rem;margin-bottom:10px;color:var(--primary);opacity:0.5}
        .camera-buttons{display:flex;gap:12px}
        .btn-secondary{flex:1;padding:12px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.9rem;cursor:pointer;transition:all 0.3s}
        .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
        .btn-capture{flex:1;padding:12px 20px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .btn-capture:hover{background:var(--primary-dark)}
        .btn-capture:disabled{opacity:0.5;cursor:not-allowed}
        .form-group{margin-bottom:18px}
        .form-group label{display:block;margin-bottom:6px;font-size:0.8rem;color:var(--text-gray);font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px 14px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.95rem;transition:all 0.3s}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .form-group input:read-only{background:var(--bg-light);color:var(--text-gray)}
        .form-group textarea{min-height:100px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .location-info{background:var(--primary-light);border-radius:8px;padding:12px 16px;margin-bottom:18px;font-size:0.85rem;color:var(--primary-dark);display:flex;align-items:center;gap:10px}
        .location-info .icon{font-size:1.2rem}
        .category-label{font-size:0.75rem;color:var(--primary-dark);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-top:20px;margin-bottom:12px;display:block}
        .allegati-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
        .allegato-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s}
        .allegato-item:hover,.allegato-item.selected{border-color:var(--primary);background:var(--primary-light)}
        .allegato-item input[type="checkbox"]{accent-color:var(--primary);width:18px;height:18px}
        .allegato-item span{font-size:0.85rem;color:var(--text-dark)}
        .email-preview{background:var(--white);border:1px solid var(--border);border-radius:8px;padding:24px;font-family:Arial,sans-serif;font-size:14px;line-height:1.6;max-height:350px;overflow-y:auto;color:#333}
        .action-buttons{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
        .btn-approve{flex:1;min-width:140px;padding:14px 20px;background:var(--success);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-approve:hover{background:#43A047;transform:translateY(-1px)}
        .btn-save{flex:1;min-width:140px;padding:14px 20px;background:var(--warning);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-save:hover{background:#F57C00;transform:translateY(-1px)}
        .btn-reject{flex:1;min-width:140px;padding:14px 20px;background:var(--white);border:1px solid var(--danger);border-radius:8px;color:var(--danger);font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-reject:hover{background:var(--danger);color:var(--white)}
        .btn-edit-toggle{padding:10px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-gray);font-family:inherit;font-size:0.85rem;cursor:pointer;transition:all 0.3s;margin-top:16px}
        .btn-edit-toggle:hover{border-color:var(--primary);color:var(--primary)}
        .edit-section{display:none;margin-top:20px}
        .edit-section.visible{display:block}
        .generate-section{text-align:center;margin-top:28px}
        .btn-generate{padding:14px 48px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s}
        .btn-generate:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .leads-table{width:100%;border-collapse:collapse}
        .leads-table th{text-align:left;padding:14px 16px;background:var(--bg-light);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-gray);font-weight:600;border-bottom:1px solid var(--border)}
        .leads-table td{padding:16px;border-bottom:1px solid var(--border);vertical-align:middle}
        .leads-table tr:hover{background:var(--primary-light)}
        .lead-name{font-weight:500;color:var(--text-dark)}
        .lead-company{font-size:0.85rem;color:var(--text-gray)}
        .lead-email{font-size:0.85rem;color:var(--primary-dark)}
        .lead-status{display:inline-block;padding:6px 14px;border-radius:20px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
        .lead-status.pending{background:#FFF8E1;color:#F9A825}
        .lead-status.approved{background:#E8F5E9;color:#43A047}
        .lead-status.rejected{background:#FFEBEE;color:#E57373}
        .lead-actions{display:flex;gap:8px}
        .btn-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-gray);cursor:pointer;transition:all 0.3s;font-size:1rem}
        .btn-icon:hover{border-color:var(--primary);color:var(--primary)}
        .btn-icon.approve:hover{border-color:var(--success);color:var(--success)}
        .btn-icon.reject:hover{border-color:var(--danger);color:var(--danger)}
        .loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-light)}
        .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:30px;right:30px;padding:16px 24px;background:var(--white);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);color:var(--text-dark);font-size:0.9rem;z-index:1000;transform:translateY(100px);opacity:0;transition:all 0.3s;display:flex;align-items:center;gap:10px}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--primary)}
        @media(max-width:768px){.header-content{flex-direction:column;gap:12px}.leads-table th:nth-child(3),.leads-table td:nth-child(3){display:none}.login-box{margin:20px;padding:30px}.tabs{flex-direction:column}.action-buttons{flex-direction:column}}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
        .empty-state .icon{font-size:3rem;margin-bottom:16px;opacity:0.5}
        .recording-section{margin-top:20px;padding:20px;background:var(--bg-light);border-radius:8px;border:1px solid var(--border)}
        .recording-toggle{display:flex;align-items:center;justify-content:space-between;gap:16px}
        .recording-label{display:flex;align-items:center;gap:10px;font-size:0.9rem;color:var(--text-dark)}
        .recording-label .mic-icon{font-size:1.3rem}
        .toggle-switch{position:relative;width:56px;height:30px;background:var(--border);border-radius:15px;cursor:pointer;transition:all 0.3s}
        .toggle-switch.active{background:var(--danger)}
        .toggle-switch::after{content:'';position:absolute;width:24px;height:24px;background:var(--white);border-radius:50%;top:3px;left:3px;transition:all 0.3s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        .toggle-switch.active::after{left:29px}
        .recording-status{font-size:0.8rem;color:var(--text-light);margin-top:12px;display:flex;align-items:center;gap:8px}
        .recording-status.active{color:var(--danger);font-weight:500}
        .recording-dot{width:10px;height:10px;background:var(--danger);border-radius:50%;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .transcription-loading{display:flex;align-items:center;gap:10px;padding:15px;background:#FFF8E1;border-radius:8px;margin-top:12px;font-size:0.85rem;color:#F9A825}
        .quick-actions{margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <p class="subtitle">CRM Portal - Gestione Contatti</p>
            <div class="select-wrapper">
                <select id="commercialeSelect">
                    <option value="">Seleziona il tuo profilo...</option>
                    <option value="marina_agliaudi">Marina Agliaudi</option>
                    <option value="federica">Federica Toscanini</option>
                    <option value="benedetta_giardino">Benedetta Giardino</option>
                    <option value="marina_raimondi">Marina Raimondi</option>
                    <option value="alessandra_spruzzola">Alessandra Spruzzola</option>
                    <option value="simona_giuppone">Simona Giuppone</option>
                </select>
            </div>
            <button class="btn-primary" id="btnLogin" disabled>Accedi</button>
        </div>
    </div>
    <header class="header" id="mainHeader" style="display:none;">
        <div class="header-content">
            <div class="logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <div class="user-info">
                <span class="user-name">Ciao, <strong id="userName"></strong></span>
                <button class="btn-logout" id="btnLogout">Esci</button>
            </div>
        </div>
    </header>
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="tabs">
                <button class="tab active" data-tab="newLead">‚ûï Nuovo Contatto</button>
                <button class="tab" data-tab="leadList">üìã Da Approvare</button>
            </div>
            <div id="tabNewLead" class="tab-content active">
                <div class="card">
                    <h2 class="card-title"><span class="icon">üì•</span> Metodo Acquisizione</h2>
                    <div class="acquisition-buttons">
                        <button class="btn-acquisition active" id="btnMethodBiglietto" data-method="biglietto">
                            <span class="icon">üì∑</span>
                            <span>Biglietto da Visita</span>
                        </button>
                        <button class="btn-acquisition" id="btnMethodNFC" data-method="nfc">
                            <span class="icon">üì±</span>
                            <span>vCard</span>
                        </button>
                        <button class="btn-acquisition" id="btnMethodManuale" data-method="manuale">
                            <span class="icon">‚úçÔ∏è</span>
                            <span>Manuale</span>
                        </button>
                    </div>
                </div>
                <div class="camera-section">
                    <div class="card" id="cameraCard">
                        <h2 class="card-title"><span class="icon">üì∑</span> Scansiona Biglietto</h2>
                        <div class="camera-container" id="cameraContainer">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <div class="icon">üì∏</div>
                                <p>Clicca per scattare foto</p>
                            </div>
                            <video id="videoElement" autoplay playsinline style="display:none;"></video>
                            <img id="capturedImage" style="display:none;">
                        </div>
                        <div class="camera-buttons">
                            <button class="btn-secondary" id="btnStartCamera">üì∑ Avvia Camera</button>
                            <button class="btn-capture" id="btnCapture" disabled>Scatta Foto</button>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
                    </div>
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üìã</span> Dati Contatto</h2>
                        <div class="location-info" id="locationInfo">
                            <span class="icon">üìç</span>
                            <span id="locationText">Rilevamento posizione...</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Data/Ora</label><input type="text" id="fieldDataOra" readonly></div>
                            <div class="form-group"><label>Fonte</label><input type="text" id="fieldFonte" value="Biglietto" readonly></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Nome</label><input type="text" id="fieldNome" placeholder="Nome"></div>
                            <div class="form-group"><label>Cognome</label><input type="text" id="fieldCognome" placeholder="Cognome"></div>
                        </div>
                        <div class="form-group"><label>Email</label><input type="email" id="fieldEmail" placeholder="email@esempio.com"></div>
                        <div class="form-group"><label>Telefono</label><input type="tel" id="fieldTelefono" placeholder="+39..."></div>
                        <div class="form-row">
                            <div class="form-group"><label>Azienda</label><input type="text" id="fieldAzienda" placeholder="Azienda"></div>
                            <div class="form-group"><label>Ruolo</label><input type="text" id="fieldRuolo" placeholder="Ruolo"></div>
                        </div>
                        <div class="form-group"><label>Indirizzo</label><input type="text" id="fieldIndirizzo" placeholder="Indirizzo"></div>
                        <div class="form-row">
                            <div class="form-group"><label>Nazione</label><input type="text" id="fieldNazione" placeholder="Nazione"></div>
                            <div class="form-group"><label>Lingua</label><select id="fieldLingua"><option value="italiano">Italiano</option><option value="english">English</option><option value="fran√ßais">Fran√ßais</option><option value="espa√±ol">Espa√±ol</option><option value="deutsch">Deutsch</option></select></div>
                        </div>
                        <div class="recording-section">
                            <div class="recording-toggle">
                                <div class="recording-label"><span class="mic-icon">üé§</span><span>Registra conversazione</span></div>
                                <div class="toggle-switch" id="recordingToggle"></div>
                            </div>
                            <div class="recording-status" id="recordingStatus"><span>Tocca per registrare</span></div>
                            <div class="transcription-loading" id="transcriptionLoading" style="display:none;">
                                <div class="spinner" style="width:20px;height:20px;margin:0;border-width:2px;"></div>
                                <span>Trascrizione in corso...</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:18px;"><label>Note Commerciale</label><textarea id="fieldNote" placeholder="Inserisci note o usa la registrazione vocale..."></textarea></div>
                        <div class="quick-actions">
                            <div class="action-buttons">
                                <button class="btn-save" id="btnQuickSave">üíæ Salva per dopo</button>
                                <button class="btn-reject" id="btnQuickReject">‚úï Scarta</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><span class="icon">üìé</span> Allegati Email</h2>
                    <span class="category-label">Interior</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_catalog"><span>Catalogo Interior 2024</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_listino"><span>Listino Interior 2025</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_novita"><span>Novit√† Interior 2025</span></label>
                    </div>
                    <span class="category-label">Lingerie</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="lingerie_catalog"><span>Catalogo Lingerie 2021</span></label>
                    </div>
                    <span class="category-label">Hotellerie</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="hotellerie_catalog"><span>Catalogo Hotellerie 2022</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="hotellerie_listino"><span>Listino Hotellerie 2023</span></label>
                    </div>
                    <span class="category-label">Generale</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="generale_catalog"><span>Catalogo Generale 2024</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="inspiration"><span>Inspiration Book</span></label>
                    </div>
                    <span class="category-label">Centenario</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_libro"><span>Libro Centenario</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_video_ita"><span>Video Centenario ITA</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_video_eng"><span>Video Centenario ENG</span></label>
                    </div>
                </div>
                <div class="generate-section"><button class="btn-generate" id="btnGenerateEmail">Genera Anteprima Email</button></div>
                <div class="card" id="emailPreviewBox" style="display:none;">
                    <h2 class="card-title"><span class="icon">‚úâÔ∏è</span> Anteprima Email</h2>
                    <div class="email-preview" id="emailPreview"></div>
                    <button class="btn-edit-toggle" id="btnEditToggle">‚úèÔ∏è Modifica email</button>
                    <div class="edit-section" id="editSection">
                        <div class="form-group"><label>Modifica testo</label><textarea id="emailEditText" style="min-height:200px;"></textarea></div>
                        <button class="btn-secondary" id="btnUpdatePreview" style="margin-top:10px;">Aggiorna anteprima</button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-approve" id="btnApprove">‚úì Approva e Invia</button>
                        <button class="btn-save" id="btnSaveForLater">üíæ Salva</button>
                        <button class="btn-reject" id="btnReject">‚úï Scarta</button>
                    </div>
                </div>
            </div>
            <div id="tabLeadList" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><span class="icon">üìã</span> Contatti da Approvare</h2>
                    <div id="leadsContainer"><div class="loading"><div class="spinner"></div>Caricamento...</div></div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <canvas id="canvas" style="display:none;"></canvas>
<script>
const API_BASE='https://giotosca.app.n8n.cloud/webhook';
let currentUser=null,currentLeadData=null,currentRowNumber=null,videoStream=null,currentEmailHtml='';
let mediaRecorder=null,audioChunks=[],isRecording=false,recordingStartTime=null,recordingTimer=null;
let currentPosition={lat:null,lng:null,location:''};
let acquisitionMethod='biglietto';
const commercialiNames={'marina_agliaudi':'Marina Agliaudi','federica':'Federica Toscanini','benedetta_giardino':'Benedetta Giardino','marina_raimondi':'Marina Raimondi','alessandra_spruzzola':'Alessandra Spruzzola','simona_giuppone':'Simona Giuppone'};

document.addEventListener('DOMContentLoaded',()=>{
    const saved=localStorage.getItem('toscanini_user');
    if(saved){currentUser=saved;showDashboard()}
    document.getElementById('commercialeSelect').addEventListener('change',e=>document.getElementById('btnLogin').disabled=!e.target.value);
    document.getElementById('btnLogin').addEventListener('click',login);
    document.getElementById('btnLogout').addEventListener('click',logout);
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
    document.getElementById('btnStartCamera').addEventListener('click',startCamera);
    document.getElementById('btnCapture').addEventListener('click',capturePhoto);
    document.getElementById('fileInput').addEventListener('change',handleFileSelect);
    document.getElementById('btnGenerateEmail').addEventListener('click',generateEmail);
    document.getElementById('btnApprove').addEventListener('click',approveLead);
    document.getElementById('btnSaveForLater').addEventListener('click',saveForLater);
    document.getElementById('btnQuickSave').addEventListener('click',saveForLater);
    document.getElementById('btnReject').addEventListener('click',rejectLead);
    document.getElementById('btnQuickReject').addEventListener('click',rejectLead);
    document.getElementById('btnEditToggle').addEventListener('click',()=>{
        const section=document.getElementById('editSection');
        section.classList.toggle('visible');
        document.getElementById('btnEditToggle').textContent=section.classList.contains('visible')?'‚úï Chiudi':'‚úèÔ∏è Modifica email';
    });
    document.getElementById('btnUpdatePreview').addEventListener('click',updatePreviewFromText);
    document.getElementById('recordingToggle').addEventListener('click',toggleRecording);
    document.querySelectorAll('.btn-acquisition').forEach(btn=>btn.addEventListener('click',()=>setAcquisitionMethod(btn.dataset.method)));
    document.querySelectorAll('.allegato-item').forEach(item=>{
        item.addEventListener('click',e=>{
            if(e.target.type!=='checkbox'){item.querySelector('input').checked=!item.querySelector('input').checked}
            item.classList.toggle('selected',item.querySelector('input').checked);
        });
    });
    initDateTime();
    initGeolocation();
});

function initDateTime(){
    const now=new Date();
    document.getElementById('fieldDataOra').value=now.toLocaleString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}

function initGeolocation(){
    if(!navigator.geolocation){document.getElementById('locationText').textContent='GPS non supportato';return}
    navigator.geolocation.getCurrentPosition(async pos=>{
        currentPosition.lat=pos.coords.latitude;
        currentPosition.lng=pos.coords.longitude;
        try{
            const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json`);
            const d=await r.json();
            currentPosition.location=[d.address.city||d.address.town||d.address.village||'',d.address.country||''].filter(Boolean).join(', ');
            document.getElementById('locationText').textContent='üìç '+currentPosition.location;
            document.getElementById('locationInfo').style.cssText='background:#E8F5E9;color:#43A047';
        }catch(e){
            currentPosition.location=`${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
            document.getElementById('locationText').textContent='üìç '+currentPosition.location;
        }
    },()=>{
        document.getElementById('locationText').textContent='Posizione non disponibile';
        document.getElementById('locationInfo').style.cssText='background:#FFEBEE;color:#E57373';
    },{enableHighAccuracy:true,timeout:10000});
}

function setAcquisitionMethod(method){
    acquisitionMethod=method;
    document.querySelectorAll('.btn-acquisition').forEach(b=>b.classList.remove('active'));
    document.querySelector(`[data-method="${method}"]`).classList.add('active');
    document.getElementById('cameraCard').style.display=method==='biglietto'?'block':'none';
    document.getElementById('fieldFonte').value=method==='biglietto'?'Biglietto':method==='nfc'?'NFC':'Manuale';
    if(method==='nfc')initNFC();
}

function initNFC(){
    if(!('NDEFReader'in window)){showToast('NFC non supportato','error');return}
    showToast('Avvicina al tag NFC...','info');
    const ndef=new NDEFReader();
    ndef.scan().then(()=>{
        ndef.onreading=e=>{
            for(const rec of e.message.records){
                if(rec.recordType==='text')parseVCard(new TextDecoder().decode(rec.data));
            }
        };
    }).catch(err=>showToast('NFC: '+err.message,'error'));
}

function parseVCard(text){
    text.split(/\r?\n/).forEach(line=>{
        if(line.startsWith('FN:')){const n=line.substring(3).split(' ');document.getElementById('fieldNome').value=n[0]||'';document.getElementById('fieldCognome').value=n.slice(1).join(' ')||''}
        if(line.startsWith('EMAIL:'))document.getElementById('fieldEmail').value=line.substring(6);
        if(line.startsWith('TEL:'))document.getElementById('fieldTelefono').value=line.substring(4);
        if(line.startsWith('ORG:'))document.getElementById('fieldAzienda').value=line.substring(4);
        if(line.startsWith('TITLE:'))document.getElementById('fieldRuolo').value=line.substring(6);
    });
    showToast('Contatto NFC importato!','success');
}

function login(){currentUser=document.getElementById('commercialeSelect').value;localStorage.setItem('toscanini_user',currentUser);showDashboard()}
function logout(){currentUser=null;localStorage.removeItem('toscanini_user');document.getElementById('loginScreen').style.display='flex';document.getElementById('mainHeader').style.display='none';document.getElementById('dashboard').classList.remove('active');stopCamera();stopRecording()}
function showDashboard(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainHeader').style.display='block';document.getElementById('dashboard').classList.add('active');document.getElementById('userName').textContent=commercialiNames[currentUser]||currentUser;loadLeads()}
function switchTab(tabId){document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tabId));document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.toggle('active',tc.id==='tab'+tabId.charAt(0).toUpperCase()+tabId.slice(1)));if(tabId==='leadList')loadLeads()}

async function startCamera(){
    // Prima ferma qualsiasi stream esistente
    await stopCamera();
    try{
        videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}});
        const video=document.getElementById('videoElement');
        video.srcObject=videoStream;
        video.style.display='block';
        // Aspetta che il video sia pronto (importante per Safari)
        await video.play();
        document.getElementById('cameraPlaceholder').style.display='none';
        document.getElementById('capturedImage').style.display='none';
        document.getElementById('btnCapture').disabled=false;
        document.getElementById('btnStartCamera').textContent='üîÑ Reset';
    }catch(e){
        console.error('Camera error:',e);
        document.getElementById('fileInput').click();
    }
}
async function stopCamera(){
    if(videoStream){
        videoStream.getTracks().forEach(t=>{t.stop();t.enabled=false});
        videoStream=null;
    }
    const video=document.getElementById('videoElement');
    if(video.srcObject){
        video.srcObject=null;
    }
    video.style.display='none';
    document.getElementById('btnCapture').disabled=true;
}
function capturePhoto(){
    const canvas=document.getElementById('canvas'),video=document.getElementById('videoElement');
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const img=canvas.toDataURL('image/jpeg',0.8);
    showCapturedImage(img);
    processImage(img.split(',')[1]);
}
function handleFileSelect(e){
    const file=e.target.files[0];
    if(file){
        const reader=new FileReader();
        reader.onload=ev=>{showCapturedImage(ev.target.result);processImage(ev.target.result.split(',')[1])};
        reader.readAsDataURL(file);
    }
    // Reset input per permettere selezione stesso file
    e.target.value='';
}
async function showCapturedImage(src){
    await stopCamera();
    document.getElementById('capturedImage').src=src;
    document.getElementById('capturedImage').style.display='block';
    document.getElementById('cameraPlaceholder').style.display='none';
    document.getElementById('btnStartCamera').textContent='üì∑ Nuova Foto';
}

async function toggleRecording(){
    if(!isRecording){
        try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder=new MediaRecorder(stream);
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
            mediaRecorder.onstop=processAudio;
            mediaRecorder.start();
            isRecording=true;
            recordingStartTime=Date.now();
            document.getElementById('recordingToggle').classList.add('active');
            document.getElementById('recordingStatus').classList.add('active');
            updateRecordingTime();
            recordingTimer=setInterval(updateRecordingTime,1000);
            showToast('Registrazione avviata','info');
        }catch(e){showToast('Errore microfono','error')}
    }else{stopRecording()}
}

function stopRecording(){
    if(mediaRecorder&&isRecording){
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t=>t.stop());
        isRecording=false;
        clearInterval(recordingTimer);
        document.getElementById('recordingToggle').classList.remove('active');
        document.getElementById('recordingStatus').classList.remove('active');
        document.getElementById('recordingStatus').innerHTML='<span>Tocca per registrare</span>';
    }
}

function updateRecordingTime(){
    const s=Math.floor((Date.now()-recordingStartTime)/1000);
    document.getElementById('recordingStatus').innerHTML=`<span class="recording-dot"></span><span class="recording-time">${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}</span><span>Registrazione...</span>`;
}

async function processAudio(){
    document.getElementById('transcriptionLoading').style.display='flex';
    showToast('Elaborazione audio...','info');
    try{
        const base64=await new Promise((res,rej)=>{const r=new FileReader();r.onloadend=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(new Blob(audioChunks,{type:'audio/webm'}))});
        const resp=await fetch(API_BASE+'/trascrivi-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audio:base64,commerciale:currentUser})});
        if(!resp.ok)throw new Error();
        const data=await resp.json();
        document.getElementById('fieldNote').value+=(document.getElementById('fieldNote').value?'\n\n':'')+data.riassunto;
        showToast('Trascrizione completata!','success');
    }catch(e){showToast('Errore trascrizione','error')}
    finally{document.getElementById('transcriptionLoading').style.display='none'}
}

async function processImage(base64){
    showToast('Elaborazione...','info');
    try{
        const r=await fetch(API_BASE+'/upload-biglietto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:base64,commerciale:currentUser,dataOra:document.getElementById('fieldDataOra').value,posizione:currentPosition.location,lat:currentPosition.lat,lng:currentPosition.lng,fonte:acquisitionMethod})});
        if(!r.ok)throw new Error();
        const d=await r.json();
        currentLeadData=d;currentRowNumber=d.row_number;
        ['nome','cognome','email','telefono','azienda','ruolo','indirizzo','nazione'].forEach(f=>{if(d[f])document.getElementById('field'+f.charAt(0).toUpperCase()+f.slice(1)).value=d[f]});
        if(d.lingua)document.getElementById('fieldLingua').value=d.lingua;
        showToast('Dati estratti!','success');
    }catch(e){showToast('Errore. Compila manualmente.','error')}
}

function getFormData(){
    return{
        nome:document.getElementById('fieldNome').value,
        cognome:document.getElementById('fieldCognome').value,
        email:document.getElementById('fieldEmail').value,
        telefono:document.getElementById('fieldTelefono').value,
        azienda:document.getElementById('fieldAzienda').value,
        ruolo:document.getElementById('fieldRuolo').value,
        indirizzo:document.getElementById('fieldIndirizzo').value,
        nazione:document.getElementById('fieldNazione').value,
        lingua:document.getElementById('fieldLingua').value,
        noteCommerciale:document.getElementById('fieldNote').value,
        allegatiSelezionati:Array.from(document.querySelectorAll('input[name="allegati"]:checked')).map(c=>c.value).join(', '),
        dataOra:document.getElementById('fieldDataOra').value,
        posizione:currentPosition.location,
        lat:currentPosition.lat,
        lng:currentPosition.lng,
        fonte:document.getElementById('fieldFonte').value
    };
}

function htmlToPlainText(html){const t=document.createElement('div');t.innerHTML=html;t.querySelectorAll('a').forEach(a=>a.textContent+=` (${a.href})`);return t.textContent||''}
function plainTextToHtml(text){let h='<div style="font-family:Arial;max-width:600px;color:#333;">';text.split('\n').filter(l=>l.trim()).forEach(l=>h+='<p>'+l.replace(/\(https?:\/\/[^\)]+\)/g,m=>`<a href="${m.slice(1,-1)}" style="color:#3AAFA9;">${m.slice(1,-1)}</a>`)+'</p>');return h+'<img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>'}
function updatePreviewFromText(){currentEmailHtml=plainTextToHtml(document.getElementById('emailEditText').value);document.getElementById('emailPreview').innerHTML=currentEmailHtml;showToast('Anteprima aggiornata','success')}

function generateEmail(){
    const d=getFormData(),lang=d.lingua,nome=d.nome,cognome=d.cognome,allegati=d.allegatiSelezionati.split(', ').filter(Boolean);
    const urls={interior_catalog:{n:'Catalogo Interior 2024',u:'https://storage.toscanini.it/toscanini_interior_catalog_2024_sept.pdf'},interior_listino:{n:'Listino Interior 2025',u:'https://storage.toscanini.it/listino-interior-2025-rev2.pdf'},interior_novita:{n:'Novit√† Interior 2025',u:'https://storage.toscanini.it/listino-interior-2025-new-collection-rev1.pdf'},lingerie_catalog:{n:'Catalogo Lingerie 2021',u:'https://www.toscanini.it/PDF/lingerie.pdf'},hotellerie_catalog:{n:'Catalogo Hotellerie 2022',u:'https://storage.toscanini.it/TOSCANINI_HOTELLERIE2022.pdf'},hotellerie_listino:{n:'Listino Hotellerie 2023',u:'https://storage.toscanini.it/Hotellerie_Jan2023.pdf'},generale_catalog:{n:'Catalogo Generale 2024',u:'https://storage.toscanini.it/Catalogo-Generale-Toscanini_2024.pdf'},inspiration:{n:'Inspiration Book',u:'http://www.toscanini.it/PDF/INSPIRATIONS_06.pdf'},centenario_libro:{n:'Libro Centenario',u:'http://www.toscanini.it/PDF/Libro_Centenario_Toscanini.pdf'},centenario_video_ita:{n:'Video Centenario ITA',u:'http://www.toscanini.it/PDF/Toscanini-100.mp4'},centenario_video_eng:{n:'Video Centenario ENG',u:'https://youtu.be/5Jl6-ZQ3kjw'}};
    let ah='';if(allegati.length){ah=(lang==='italiano'?'<p><b>Documentazione:</b></p>':'<p><b>Documentation:</b></p>')+'<ul style="margin:10px 0 20px 20px;">';allegati.forEach(k=>{if(urls[k])ah+=`<li style="margin:5px 0;"><a href="${urls[k].u}" style="color:#3AAFA9;">${urls[k].n}</a></li>`});ah+='</ul>'}
    currentEmailHtml=lang==='italiano'?`<div style="font-family:Arial;max-width:600px;color:#333;"><p>Gentile ${nome} ${cognome},</p><p>√à stato un piacere incontrarLa e presentarLe le nostre collezioni.</p><p>Come discusso, Le invio la documentazione:</p>${ah}<p>Rimango a disposizione.</p><p>Instagram: <a href="https://www.instagram.com/toscanini_official/" style="color:#3AAFA9;">@toscanini_official</a></p><p>Cordiali saluti,</p><p><b>Industrie Toscanini S.r.l.</b><br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>`:`<div style="font-family:Arial;max-width:600px;color:#333;"><p>Dear ${nome} ${cognome},</p><p>It was a pleasure meeting you and presenting our collections.</p><p>As discussed, please find the documentation:</p>${ah}<p>Don't hesitate to contact me.</p><p>Instagram: <a href="https://www.instagram.com/toscanini_official/" style="color:#3AAFA9;">@toscanini_official</a></p><p>Best regards,</p><p><b>Industrie Toscanini S.r.l.</b><br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>`;
    document.getElementById('emailPreview').innerHTML=currentEmailHtml;
    document.getElementById('emailEditText').value=htmlToPlainText(currentEmailHtml);
    document.getElementById('emailPreviewBox').style.display='block';
    document.getElementById('emailPreviewBox').scrollIntoView({behavior:'smooth'});
}

async function saveForLater(){
    const d=getFormData();
    if(!d.nome&&!d.email&&!d.azienda){showToast('Inserisci almeno un dato','error');return}
    showToast('Salvataggio...','info');
    try{
        const r=await fetch(API_BASE+'/salva-contatto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...d,commerciale:currentUser,status:'da_approvare'})});
        if(!r.ok)throw new Error();
        const data=await r.json();
        currentRowNumber=data.row_number;
        showToast('Salvato!','success');
        resetForm();
    }catch(e){showToast('Errore','error')}
}

async function approveLead(){
    const d=getFormData();
    if(!d.nome&&!d.email){showToast('Inserisci nome o email','error');return}
    showToast('Invio...','info');
    try{
        const r=await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...d,row_number:currentRowNumber,commerciale:currentUser,emailGenerata:currentEmailHtml,status:'approvato'})});
        if(!r.ok)throw new Error();
        showToast('Approvato! Email inviata.','success');
        resetForm();
    }catch(e){showToast('Errore','error')}
}

async function rejectLead(){
    if(!currentRowNumber){resetForm();return}
    const m=prompt('Motivo (opzionale):');
    try{
        await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:currentRowNumber,motivoScarto:m||''})});
        showToast('Scartato','success');
        resetForm();
    }catch(e){showToast('Errore','error')}
}

function resetForm(){
    ['fieldNome','fieldCognome','fieldEmail','fieldTelefono','fieldAzienda','fieldRuolo','fieldIndirizzo','fieldNazione','fieldNote'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('fieldLingua').value='italiano';
    document.querySelectorAll('input[name="allegati"]').forEach(c=>{c.checked=false;c.closest('.allegato-item').classList.remove('selected')});
    document.getElementById('emailPreviewBox').style.display='none';
    document.getElementById('capturedImage').style.display='none';
    document.getElementById('cameraPlaceholder').style.display='block';
    document.getElementById('btnStartCamera').textContent='üì∑ Avvia Camera';
    currentLeadData=null;currentRowNumber=null;currentEmailHtml='';
    initDateTime();
    // Torna all'inizio della pagina
    window.scrollTo({top:0,behavior:'smooth'});
}

async function loadLeads(){
    const container=document.getElementById('leadsContainer');
    container.innerHTML='<div class="loading"><div class="spinner"></div>Caricamento...</div>';
    try{
        const r=await fetch(API_BASE+'/leads');
        const leads=await r.json();
        if(!leads.length){container.innerHTML='<div class="empty-state"><div class="icon">üì≠</div><p>Nessun contatto da approvare</p></div>';return}
        container.innerHTML=`<table class="leads-table"><thead><tr><th>Nome</th><th>Azienda</th><th>Posizione</th><th>Stato</th><th>Azioni</th></tr></thead><tbody>${leads.map(l=>`<tr><td class="lead-name">${l.nome||''} ${l.cognome||''}</td><td class="lead-company">${l.azienda||'-'}</td><td>${l.posizione||'-'}</td><td><span class="lead-status ${l.status==='approvato'?'approved':l.status==='scartato'?'rejected':'pending'}">${l.status==='approvato'?'Approvato':l.status==='scartato'?'Scartato':'Da Approvare'}</span></td><td class="lead-actions"><button class="btn-icon approve" onclick="quickApprove(${l.row_number})">‚úì</button><button class="btn-icon reject" onclick="quickReject(${l.row_number})">‚úï</button></td></tr>`).join('')}</tbody></table>`;
    }catch(e){container.innerHTML='<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Errore caricamento</p></div>'}
}

async function quickApprove(row){if(!confirm('Approvare e inviare email?'))return;try{await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:row,commerciale:currentUser})});showToast('Approvato!','success');loadLeads()}catch(e){showToast('Errore','error')}}
async function quickReject(row){const m=prompt('Motivo:');try{await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:row,motivoScarto:m||''})});showToast('Scartato','success');loadLeads()}catch(e){showToast('Errore','error')}}

function showToast(msg,type='info'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type+' show';setTimeout(()=>t.classList.remove('show'),3000)}
</script>
</body>
</html>

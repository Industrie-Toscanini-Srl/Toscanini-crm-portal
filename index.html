<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toscanini CRM Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#3AAFA9;--primary-dark:#2B7A78;--primary-light:#DEF2F1;--text-dark:#17252A;--text-gray:#5C6B6B;--text-light:#8A9A9A;--white:#FFFFFF;--bg-light:#FAFAFA;--border:#E8E8E8;--success:#4CAF50;--danger:#E57373;--shadow:0 2px 10px rgba(0,0,0,0.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Open Sans',sans-serif;background:var(--bg-light);color:var(--text-dark);line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:var(--white);border-bottom:1px solid var(--border);padding:15px 0;position:sticky;top:0;z-index:100}
        .header-content{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
        .logo img{height:28px;width:auto}
        .user-info{display:flex;align-items:center;gap:20px}
        .user-name{font-size:0.9rem;color:var(--text-gray)}
        .user-name strong{color:var(--primary-dark);font-weight:600}
        .btn-logout{padding:8px 20px;background:transparent;border:1px solid var(--border);color:var(--text-gray);font-size:0.85rem;cursor:pointer;transition:all 0.3s;border-radius:4px}
        .btn-logout:hover{border-color:var(--primary);color:var(--primary)}
        .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary-light),var(--white));animation:fadeIn 0.5s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .login-box{background:var(--white);border-radius:12px;padding:50px;max-width:420px;width:100%;text-align:center;box-shadow:var(--shadow)}
        .login-logo{margin-bottom:20px}
        .login-logo img{height:36px;width:auto}
        .login-box .subtitle{color:var(--text-light);margin-bottom:40px;font-size:0.9rem}
        .select-wrapper{position:relative;margin-bottom:24px}
        .select-wrapper select{width:100%;padding:14px 18px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.95rem;cursor:pointer;appearance:none;transition:all 0.3s}
        .select-wrapper select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .select-wrapper::after{content:'‚ñæ';position:absolute;right:18px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none}
        .btn-primary{width:100%;padding:14px 28px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .dashboard{display:none;animation:fadeIn 0.5s}
        .dashboard.active{display:block}
        .tabs{display:flex;background:var(--white);border-radius:8px;padding:6px;margin:24px 0;box-shadow:var(--shadow)}
        .tab{flex:1;padding:14px 24px;background:transparent;border:none;border-radius:6px;color:var(--text-gray);font-family:inherit;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .tab:hover{color:var(--text-dark)}
        .tab.active{background:var(--primary);color:var(--white)}
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn 0.3s}
        .card{background:var(--white);border-radius:12px;padding:28px;margin-bottom:20px;box-shadow:var(--shadow)}
        .card-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:500;color:var(--text-dark);margin-bottom:20px;display:flex;align-items:center;gap:10px}
        .card-title .icon{color:var(--primary)}
        .camera-section{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        @media(max-width:900px){.camera-section{grid-template-columns:1fr}}
        .camera-container{width:100%;aspect-ratio:4/3;background:var(--bg-light);border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:16px}
        .camera-container video,.camera-container img{width:100%;height:100%;object-fit:cover;border-radius:6px}
        .camera-placeholder{text-align:center;color:var(--text-light)}
        .camera-placeholder .icon{font-size:3rem;margin-bottom:10px;color:var(--primary);opacity:0.5}
        .camera-buttons{display:flex;gap:12px}
        .btn-secondary{flex:1;padding:12px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.9rem;cursor:pointer;transition:all 0.3s}
        .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
        .btn-capture{flex:1;padding:12px 20px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.3s}
        .btn-capture:hover{background:var(--primary-dark)}
        .btn-capture:disabled{opacity:0.5;cursor:not-allowed}
        .form-group{margin-bottom:18px}
        .form-group label{display:block;margin-bottom:6px;font-size:0.8rem;color:var(--text-gray);font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:12px 14px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-dark);font-family:inherit;font-size:0.95rem;transition:all 0.3s}
        .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
        .form-group textarea{min-height:100px;resize:vertical}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .category-label{font-size:0.75rem;color:var(--primary-dark);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-top:20px;margin-bottom:12px;display:block}
        .allegati-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
        .allegato-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s}
        .allegato-item:hover,.allegato-item.selected{border-color:var(--primary);background:var(--primary-light)}
        .allegato-item input[type="checkbox"]{accent-color:var(--primary);width:18px;height:18px}
        .allegato-item span{font-size:0.85rem;color:var(--text-dark)}
        .email-preview{background:var(--white);border:1px solid var(--border);border-radius:8px;padding:24px;font-family:Arial,sans-serif;font-size:14px;line-height:1.6;max-height:350px;overflow-y:auto;color:#333}
        .action-buttons{display:flex;gap:16px;margin-top:24px}
        .btn-approve{flex:1;padding:14px 28px;background:var(--success);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-approve:hover{background:#43A047;transform:translateY(-1px)}
        .btn-reject{flex:1;padding:14px 28px;background:var(--white);border:1px solid var(--danger);border-radius:8px;color:var(--danger);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-reject:hover{background:var(--danger);color:var(--white)}
        .btn-edit-toggle{padding:10px 20px;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-gray);font-family:inherit;font-size:0.85rem;cursor:pointer;transition:all 0.3s;margin-top:16px}
        .btn-edit-toggle:hover{border-color:var(--primary);color:var(--primary)}
        .edit-section{display:none;margin-top:20px}
        .edit-section.visible{display:block}
        .generate-section{text-align:center;margin-top:28px}
        .btn-generate{padding:14px 48px;background:var(--primary);border:none;border-radius:8px;color:var(--white);font-family:inherit;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.3s}
        .btn-generate:hover{background:var(--primary-dark);transform:translateY(-1px)}
        .leads-table{width:100%;border-collapse:collapse}
        .leads-table th{text-align:left;padding:14px 16px;background:var(--bg-light);font-size:0.75rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-gray);font-weight:600;border-bottom:1px solid var(--border)}
        .leads-table td{padding:16px;border-bottom:1px solid var(--border);vertical-align:middle}
        .leads-table tr:hover{background:var(--primary-light)}
        .lead-name{font-weight:500;color:var(--text-dark)}
        .lead-company{font-size:0.85rem;color:var(--text-gray)}
        .lead-email{font-size:0.85rem;color:var(--primary-dark)}
        .lead-status{display:inline-block;padding:6px 14px;border-radius:20px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
        .lead-status.pending{background:#FFF8E1;color:#F9A825}
        .lead-status.approved{background:#E8F5E9;color:#43A047}
        .lead-status.rejected{background:#FFEBEE;color:#E57373}
        .lead-actions{display:flex;gap:8px}
        .btn-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--white);border:1px solid var(--border);border-radius:8px;color:var(--text-gray);cursor:pointer;transition:all 0.3s;font-size:1rem}
        .btn-icon:hover{border-color:var(--primary);color:var(--primary)}
        .btn-icon.approve:hover{border-color:var(--success);color:var(--success)}
        .btn-icon.reject:hover{border-color:var(--danger);color:var(--danger)}
        .loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-light)}
        .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast{position:fixed;bottom:30px;right:30px;padding:16px 24px;background:var(--white);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);color:var(--text-dark);font-size:0.9rem;z-index:1000;transform:translateY(100px);opacity:0;transition:all 0.3s;display:flex;align-items:center;gap:10px}
        .toast.show{transform:translateY(0);opacity:1}
        .toast.success{border-left:4px solid var(--success)}
        .toast.error{border-left:4px solid var(--danger)}
        .toast.info{border-left:4px solid var(--primary)}
        @media(max-width:768px){.header-content{flex-direction:column;gap:12px}.leads-table th:nth-child(3),.leads-table td:nth-child(3),.leads-table th:nth-child(4),.leads-table td:nth-child(4){display:none}.login-box{margin:20px;padding:30px}.tabs{flex-direction:column}.action-buttons{flex-direction:column}}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
        .empty-state .icon{font-size:3rem;margin-bottom:16px;opacity:0.5}
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <p class="subtitle">CRM Portal - Gestione Lead</p>
            <div class="select-wrapper">
                <select id="commercialeSelect">
                    <option value="">Seleziona il tuo profilo...</option>
                    <option value="marina_agliaudi">Marina Agliaudi</option>
                    <option value="federica">Federica Toscanini</option>
                    <option value="benedetta_giardino">Benedetta Giardino</option>
                    <option value="marina_raimondi">Marina Raimondi</option>
                    <option value="alessandra_spruzzola">Alessandra Spruzzola</option>
                    <option value="simona_giuppone">Simona Giuppone</option>
                </select>
            </div>
            <button class="btn-primary" id="btnLogin" disabled>Accedi</button>
        </div>
    </div>
    <header class="header" id="mainHeader" style="display:none;">
        <div class="header-content">
            <div class="logo"><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/Toscanini.png" alt="Toscanini"></div>
            <div class="user-info">
                <span class="user-name">Ciao, <strong id="userName"></strong></span>
                <button class="btn-logout" id="btnLogout">Esci</button>
            </div>
        </div>
    </header>
    <div id="dashboard" class="dashboard">
        <div class="container">
            <div class="tabs">
                <button class="tab active" data-tab="newLead">‚ûï Nuovo Lead</button>
                <button class="tab" data-tab="leadList">üìã Lead in Attesa</button>
            </div>
            <div id="tabNewLead" class="tab-content active">
                <div class="camera-section">
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üì∑</span> Scansiona Biglietto</h2>
                        <div class="camera-container" id="cameraContainer">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <div class="icon">üì∏</div>
                                <p>Clicca "Avvia Camera" per iniziare</p>
                            </div>
                            <video id="videoElement" autoplay playsinline style="display:none;"></video>
                            <img id="capturedImage" style="display:none;">
                        </div>
                        <div class="camera-buttons">
                            <button class="btn-secondary" id="btnStartCamera">üì∑ Avvia Camera</button>
                            <button class="btn-capture" id="btnCapture" disabled>Scatta Foto</button>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none;">
                    </div>
                    <div class="card">
                        <h2 class="card-title"><span class="icon">üìã</span> Dati Estratti</h2>
                        <div class="form-row">
                            <div class="form-group"><label>Nome</label><input type="text" id="fieldNome" placeholder="Nome"></div>
                            <div class="form-group"><label>Cognome</label><input type="text" id="fieldCognome" placeholder="Cognome"></div>
                        </div>
                        <div class="form-group"><label>Email</label><input type="email" id="fieldEmail" placeholder="email@esempio.com"></div>
                        <div class="form-group"><label>Telefono</label><input type="tel" id="fieldTelefono" placeholder="+39..."></div>
                        <div class="form-row">
                            <div class="form-group"><label>Azienda</label><input type="text" id="fieldAzienda" placeholder="Azienda"></div>
                            <div class="form-group"><label>Ruolo</label><input type="text" id="fieldRuolo" placeholder="Ruolo"></div>
                        </div>
                        <div class="form-group"><label>Indirizzo</label><input type="text" id="fieldIndirizzo" placeholder="Indirizzo"></div>
                        <div class="form-row">
                            <div class="form-group"><label>Nazione</label><input type="text" id="fieldNazione" placeholder="Nazione"></div>
                            <div class="form-group"><label>Lingua</label><select id="fieldLingua"><option value="italiano">Italiano</option><option value="english">English</option><option value="fran√ßais">Fran√ßais</option><option value="espa√±ol">Espa√±ol</option><option value="deutsch">Deutsch</option></select></div>
                        </div>
                        <div class="form-group"><label>Note Commerciale</label><textarea id="fieldNote" placeholder="Inserisci note..."></textarea></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="card-title"><span class="icon">üìé</span> Seleziona Allegati</h2>
                    <span class="category-label">Interior</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_catalog"><span>Catalogo Interior 2024</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_listino"><span>Listino Interior 2025</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="interior_novita"><span>Novit√† Interior 2025</span></label>
                    </div>
                    <span class="category-label">Lingerie</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="lingerie_catalog"><span>Catalogo Lingerie 2021</span></label>
                    </div>
                    <span class="category-label">Hotellerie</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="hotellerie_catalog"><span>Catalogo Hotellerie 2022</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="hotellerie_listino"><span>Listino Hotellerie 2023</span></label>
                    </div>
                    <span class="category-label">Generale</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="generale_catalog"><span>Catalogo Generale 2024</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="inspiration"><span>Inspiration Book</span></label>
                    </div>
                    <span class="category-label">Centenario</span>
                    <div class="allegati-grid">
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_libro"><span>Libro Centenario</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_video_ita"><span>Video Centenario ITA</span></label>
                        <label class="allegato-item"><input type="checkbox" name="allegati" value="centenario_video_eng"><span>Video Centenario ENG</span></label>
                    </div>
                </div>
                <div class="generate-section"><button class="btn-generate" id="btnGenerateEmail">Genera Anteprima Email</button></div>
                <div class="card" id="emailPreviewBox" style="display:none;">
                    <h2 class="card-title"><span class="icon">‚úâÔ∏è</span> Anteprima Email</h2>
                    <div class="email-preview" id="emailPreview"></div>
                    <button class="btn-edit-toggle" id="btnEditToggle">‚úèÔ∏è Modifica testo email</button>
                    <div class="edit-section" id="editSection">
                        <div class="form-group"><label>Modifica il testo dell'email</label><textarea id="emailEditText" style="min-height:200px;"></textarea></div>
                        <button class="btn-secondary" id="btnUpdatePreview" style="margin-top:10px;">Aggiorna anteprima</button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-approve" id="btnApprove">‚úì Approva e Invia</button>
                        <button class="btn-reject" id="btnReject">‚úï Scarta</button>
                    </div>
                </div>
            </div>
            <div id="tabLeadList" class="tab-content">
                <div class="card">
                    <h2 class="card-title"><span class="icon">üìã</span> Lead in Attesa</h2>
                    <div id="leadsContainer"><div class="loading"><div class="spinner"></div>Caricamento...</div></div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <canvas id="canvas" style="display:none;"></canvas>
    <script>
const API_BASE='https://giotosca.app.n8n.cloud/webhook';
let currentUser=null,currentLeadData=null,currentRowNumber=null,videoStream=null,currentEmailHtml='';
const commercialiNames={'marina_agliaudi':'Marina Agliaudi','federica':'Federica Toscanini','benedetta_giardino':'Benedetta Giardino','marina_raimondi':'Marina Raimondi','alessandra_spruzzola':'Alessandra Spruzzola','simona_giuppone':'Simona Giuppone'};
document.addEventListener('DOMContentLoaded',()=>{
    const saved=localStorage.getItem('toscanini_user');
    if(saved){currentUser=saved;showDashboard()}
    document.getElementById('commercialeSelect').addEventListener('change',e=>document.getElementById('btnLogin').disabled=!e.target.value);
    document.getElementById('btnLogin').addEventListener('click',login);
    document.getElementById('btnLogout').addEventListener('click',logout);
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
    document.getElementById('btnStartCamera').addEventListener('click',startCamera);
    document.getElementById('btnCapture').addEventListener('click',capturePhoto);
    document.getElementById('fileInput').addEventListener('change',handleFileSelect);
    document.getElementById('btnGenerateEmail').addEventListener('click',generateEmail);
    document.getElementById('btnApprove').addEventListener('click',approveLead);
    document.getElementById('btnReject').addEventListener('click',rejectLead);
    document.getElementById('btnEditToggle').addEventListener('click',()=>{
        const section=document.getElementById('editSection');
        section.classList.toggle('visible');
        document.getElementById('btnEditToggle').textContent=section.classList.contains('visible')?'‚úï Chiudi modifica':'‚úèÔ∏è Modifica testo email';
    });
    document.getElementById('btnUpdatePreview').addEventListener('click',updatePreviewFromText);
    document.querySelectorAll('.allegato-item').forEach(item=>{
        item.addEventListener('click',e=>{
            if(e.target.type!=='checkbox'){const cb=item.querySelector('input');cb.checked=!cb.checked}
            item.classList.toggle('selected',item.querySelector('input').checked);
        });
    });
});
function login(){currentUser=document.getElementById('commercialeSelect').value;localStorage.setItem('toscanini_user',currentUser);showDashboard()}
function logout(){currentUser=null;localStorage.removeItem('toscanini_user');document.getElementById('loginScreen').style.display='flex';document.getElementById('mainHeader').style.display='none';document.getElementById('dashboard').classList.remove('active');stopCamera()}
function showDashboard(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainHeader').style.display='block';document.getElementById('dashboard').classList.add('active');document.getElementById('userName').textContent=commercialiNames[currentUser]||currentUser;loadLeads()}
function switchTab(tabId){document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tabId));document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.toggle('active',tc.id==='tab'+tabId.charAt(0).toUpperCase()+tabId.slice(1)));if(tabId==='leadList')loadLeads()}
async function startCamera(){try{videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}}});document.getElementById('videoElement').srcObject=videoStream;document.getElementById('videoElement').style.display='block';document.getElementById('cameraPlaceholder').style.display='none';document.getElementById('capturedImage').style.display='none';document.getElementById('btnCapture').disabled=false;document.getElementById('btnStartCamera').textContent='üîÑ Cambia'}catch(e){document.getElementById('fileInput').click()}}
function stopCamera(){if(videoStream){videoStream.getTracks().forEach(t=>t.stop());videoStream=null}document.getElementById('videoElement').style.display='none';document.getElementById('btnCapture').disabled=true}
function capturePhoto(){const canvas=document.getElementById('canvas'),video=document.getElementById('videoElement');canvas.width=video.videoWidth;canvas.height=video.videoHeight;canvas.getContext('2d').drawImage(video,0,0);const img=canvas.toDataURL('image/jpeg',0.8);showCapturedImage(img);processImage(img.split(',')[1])}
function handleFileSelect(e){const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=ev=>{showCapturedImage(ev.target.result);processImage(ev.target.result.split(',')[1])};reader.readAsDataURL(file)}}
function showCapturedImage(src){stopCamera();document.getElementById('capturedImage').src=src;document.getElementById('capturedImage').style.display='block';document.getElementById('cameraPlaceholder').style.display='none';document.getElementById('btnStartCamera').textContent='üì∑ Nuova Foto'}
async function processImage(base64){showToast('Elaborazione...','info');try{const r=await fetch(API_BASE+'/upload-biglietto',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:base64,commerciale:currentUser,allegatiSelezionati:getSelectedAllegati()})});if(!r.ok)throw new Error();const d=await r.json();currentLeadData=d;currentRowNumber=d.row_number;document.getElementById('fieldNome').value=d.nome||'';document.getElementById('fieldCognome').value=d.cognome||'';document.getElementById('fieldEmail').value=d.email||'';document.getElementById('fieldTelefono').value=d.telefono||'';document.getElementById('fieldAzienda').value=d.azienda||'';document.getElementById('fieldRuolo').value=d.ruolo||'';document.getElementById('fieldIndirizzo').value=d.indirizzo||'';document.getElementById('fieldNazione').value=d.nazione||'';document.getElementById('fieldLingua').value=d.lingua||'italiano';if(d.emailGenerata){currentEmailHtml=d.emailGenerata;document.getElementById('emailPreview').innerHTML=d.emailGenerata;document.getElementById('emailEditText').value=htmlToPlainText(d.emailGenerata);document.getElementById('emailPreviewBox').style.display='block'}showToast('Dati estratti!','success')}catch(e){showToast('Errore. Compila manualmente.','error')}}
function htmlToPlainText(html){const tmp=document.createElement('div');tmp.innerHTML=html;const links=tmp.querySelectorAll('a');links.forEach(a=>{a.textContent=a.textContent+' ('+a.href+')';});return tmp.textContent||tmp.innerText||'';}
function plainTextToHtml(text,lang){const lines=text.split('\n').filter(l=>l.trim());let html='<div style="font-family:Arial;max-width:600px;color:#333;">';lines.forEach(line=>{if(line.trim())html+='<p>'+line.replace(/\(https?:\/\/[^\)]+\)/g,match=>{const url=match.slice(1,-1);return '<a href="'+url+'" style="color:#3AAFA9;">'+url+'</a>';})+'</p>';});html+='<img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>';return html;}
function updatePreviewFromText(){const text=document.getElementById('emailEditText').value;const lang=document.getElementById('fieldLingua').value;currentEmailHtml=plainTextToHtml(text,lang);document.getElementById('emailPreview').innerHTML=currentEmailHtml;showToast('Anteprima aggiornata','success');}
function generateEmail(){const lang=document.getElementById('fieldLingua').value,nome=document.getElementById('fieldNome').value,cognome=document.getElementById('fieldCognome').value,allegati=getSelectedAllegati();const urls={'interior_catalog':{n:'Catalogo Interior 2024',u:'https://storage.toscanini.it/toscanini_interior_catalog_2024_sept.pdf'},'interior_listino':{n:'Listino Interior 2025',u:'https://storage.toscanini.it/listino-interior-2025-rev2.pdf'},'interior_novita':{n:'Novit√† Interior 2025',u:'https://storage.toscanini.it/listino-interior-2025-new-collection-rev1.pdf'},'lingerie_catalog':{n:'Catalogo Lingerie 2021',u:'https://www.toscanini.it/PDF/lingerie.pdf'},'hotellerie_catalog':{n:'Catalogo Hotellerie 2022',u:'https://storage.toscanini.it/TOSCANINI_HOTELLERIE2022.pdf'},'hotellerie_listino':{n:'Listino Hotellerie 2023',u:'https://storage.toscanini.it/Hotellerie_Jan2023.pdf'},'generale_catalog':{n:'Catalogo Generale 2024',u:'https://storage.toscanini.it/Catalogo-Generale-Toscanini_2024.pdf'},'inspiration':{n:'Inspiration Book',u:'http://www.toscanini.it/PDF/INSPIRATIONS_06.pdf'},'centenario_libro':{n:'Libro Centenario',u:'http://www.toscanini.it/PDF/Libro_Centenario_Toscanini.pdf'},'centenario_video_ita':{n:'Video Centenario ITA',u:'http://www.toscanini.it/PDF/Toscanini-100.mp4'},'centenario_video_eng':{n:'Video Centenario ENG',u:'https://youtu.be/5Jl6-ZQ3kjw'}};
let ah='';if(allegati.length){ah=(lang==='italiano'?'<p><b>Documentazione:</b></p>':'<p><b>Documentation:</b></p>')+'<ul style="margin:10px 0 20px 20px;">';allegati.forEach(k=>{if(urls[k])ah+='<li style="margin:5px 0;"><a href="'+urls[k].u+'" style="color:#3AAFA9;">'+urls[k].n+'</a></li>'});ah+='</ul>'}
const html=lang==='italiano'?'<div style="font-family:Arial;max-width:600px;color:#333;"><p>Gentile '+nome+' '+cognome+',</p><p>√à stato un piacere incontrarLa e presentarLe le nostre collezioni.</p><p>Come discusso, Le invio la documentazione:</p>'+ah+'<p>Rimango a disposizione.</p><p>Instagram: <a href="https://www.instagram.com/toscanini_official/" style="color:#3AAFA9;">@toscanini_official</a></p><p>Cordiali saluti,</p><p><b>Industrie Toscanini S.r.l.</b><br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>':'<div style="font-family:Arial;max-width:600px;color:#333;"><p>Dear '+nome+' '+cognome+',</p><p>It was a pleasure meeting you and presenting our collections.</p><p>As discussed, please find the documentation:</p>'+ah+'<p>Don\'t hesitate to contact me.</p><p>Instagram: <a href="https://www.instagram.com/toscanini_official/" style="color:#3AAFA9;">@toscanini_official</a></p><p>Best regards,</p><p><b>Industrie Toscanini S.r.l.</b><br><a href="https://www.toscanini.it" style="color:#3AAFA9;">www.toscanini.it</a></p><img src="https://raw.githubusercontent.com/Industrie-Toscanini-Srl/Toscanini-crm-portal/main/FIRMA_MIAMI_03_LOW2.jpg" style="max-width:400px;margin-top:20px;"></div>';
currentEmailHtml=html;
document.getElementById('emailPreview').innerHTML=html;
document.getElementById('emailEditText').value=htmlToPlainText(html);
document.getElementById('emailPreviewBox').style.display='block';
document.getElementById('emailPreviewBox').scrollIntoView({behavior:'smooth'});
document.getElementById('editSection').classList.remove('visible');
document.getElementById('btnEditToggle').textContent='‚úèÔ∏è Modifica testo email';
currentLeadData={nome:document.getElementById('fieldNome').value,cognome:document.getElementById('fieldCognome').value,email:document.getElementById('fieldEmail').value,telefono:document.getElementById('fieldTelefono').value,azienda:document.getElementById('fieldAzienda').value,ruolo:document.getElementById('fieldRuolo').value,indirizzo:document.getElementById('fieldIndirizzo').value,nazione:document.getElementById('fieldNazione').value,lingua:document.getElementById('fieldLingua').value,noteCommerciale:document.getElementById('fieldNote').value,allegatiSelezionati:allegati.join(', '),emailGenerata:html}}
function getSelectedAllegati(){return Array.from(document.querySelectorAll('input[name="allegati"]:checked')).map(c=>c.value)}
async function approveLead(){if(!currentLeadData){showToast('Nessun lead','error');return}showToast('Invio...','info');try{const r=await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:currentRowNumber||currentLeadData.row_number,commerciale:currentUser,nome:currentLeadData.nome,cognome:currentLeadData.cognome,azienda:currentLeadData.azienda,noteCommerciale:document.getElementById('fieldNote').value,allegatiSelezionati:getSelectedAllegati().join(', '),emailGenerata:currentEmailHtml})});if(!r.ok)throw new Error();showToast('Approvato! Email inviata.','success');resetForm()}catch(e){showToast('Errore','error')}}
async function rejectLead(){if(!currentRowNumber&&!currentLeadData?.row_number){showToast('Nessun lead','error');return}const m=prompt('Motivo (opzionale):');try{const r=await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:currentRowNumber||currentLeadData.row_number,motivoScarto:m||''})});if(!r.ok)throw new Error();showToast('Scartato','success');resetForm()}catch(e){showToast('Errore','error')}}
function resetForm(){['fieldNome','fieldCognome','fieldEmail','fieldTelefono','fieldAzienda','fieldRuolo','fieldIndirizzo','fieldNazione','fieldNote'].forEach(id=>document.getElementById(id).value='');document.getElementById('fieldLingua').value='italiano';document.querySelectorAll('input[name="allegati"]').forEach(c=>{c.checked=false;c.closest('.allegato-item').classList.remove('selected')});document.getElementById('emailPreviewBox').style.display='none';document.getElementById('capturedImage').style.display='none';document.getElementById('cameraPlaceholder').style.display='block';document.getElementById('btnStartCamera').textContent='üì∑ Avvia Camera';document.getElementById('editSection').classList.remove('visible');document.getElementById('btnEditToggle').textContent='‚úèÔ∏è Modifica testo email';currentLeadData=null;currentRowNumber=null;currentEmailHtml=''}
async function loadLeads(){const container=document.getElementById('leadsContainer');container.innerHTML='<div class="loading"><div class="spinner"></div>Caricamento...</div>';try{const r=await fetch(API_BASE+'/leads');if(!r.ok)throw new Error();const leads=await r.json();if(!leads.length){container.innerHTML='<div class="empty-state"><div class="icon">üì≠</div><p>Nessun lead</p></div>';return}container.innerHTML='<table class="leads-table"><thead><tr><th>Nome</th><th>Azienda</th><th>Email</th><th>Stato</th><th>Azioni</th></tr></thead><tbody>'+leads.map(l=>'<tr><td class="lead-name">'+(l.nome||'')+' '+(l.cognome||'')+'</td><td class="lead-company">'+(l.azienda||'-')+'</td><td class="lead-email">'+(l.email||'-')+'</td><td><span class="lead-status '+getStatusClass(l.status)+'">'+getStatusLabel(l.status)+'</span></td><td class="lead-actions"><button class="btn-icon approve" onclick="quickApprove('+l.row_number+')">‚úì</button><button class="btn-icon reject" onclick="quickReject('+l.row_number+')">‚úï</button></td></tr>').join('')+'</tbody></table>'}catch(e){container.innerHTML='<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Errore</p></div>'}}
function getStatusClass(s){if(!s||s===''||s==='in_attesa')return'pending';if(s==='approvato')return'approved';if(s==='scartato')return'rejected';return'pending'}
function getStatusLabel(s){if(!s||s===''||s==='in_attesa')return'In Attesa';if(s==='approvato')return'Approvato';if(s==='scartato')return'Scartato';return s}
async function quickApprove(row){if(!confirm('Approvare?'))return;try{const r=await fetch(API_BASE+'/approva',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:row,commerciale:currentUser,noteCommerciale:'',allegatiSelezionati:'',emailGenerata:''})});if(!r.ok)throw new Error();showToast('Approvato!','success');loadLeads()}catch(e){showToast('Errore','error')}}
async function quickReject(row){const m=prompt('Motivo (opzionale):');try{const r=await fetch(API_BASE+'/scarta',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row_number:row,motivoScarto:m||''})});if(!r.ok)throw new Error();showToast('Scartato','success');loadLeads()}catch(e){showToast('Errore','error')}}
function showToast(msg,type='info'){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type+' show';setTimeout(()=>t.classList.remove('show'),3000)}
    </script>
</body>
</html>
